<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchestrator Troubleshooter v2.0 - by Gashie</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #131920;
            --bg-tertiary: #1a2028;
            --bg-card: #1e2530;
            --border-color: #2d3848;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-blue: #58a6ff;
            --accent-cyan: #39c5cf;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-orange: #db6d28;
            --accent-purple: #a371f7;
            --accent-pink: #db61a2;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-3: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', 'SF Pro Display', -apple-system, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left { display: flex; align-items: center; gap: 16px; }
        .logo { font-size: 20px; font-weight: 700; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .author { color: var(--text-muted); font-size: 12px; }
        .header-status { display: flex; gap: 20px; font-size: 12px; }
        .status-item { display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green); }
        .status-dot.error { background: var(--accent-red); }

        /* Search */
        .search-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 24px;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .search-input {
            flex: 1;
            max-width: 500px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 16px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }
        .search-input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(88,166,255,0.15); }
        .btn-search {
            background: var(--gradient-1);
            border: none;
            border-radius: 8px;
            padding: 10px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-search:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }

        /* Main Layout */
        .main { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 16px 0;
        }
        .sidebar-section { margin-bottom: 24px; }
        .sidebar-title { color: var(--text-muted); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; padding: 0 20px; margin-bottom: 8px; }
        .sidebar-item {
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            color: var(--text-secondary);
        }
        .sidebar-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .sidebar-item.active { background: var(--bg-tertiary); border-left-color: var(--accent-blue); color: var(--accent-blue); }
        .sidebar-icon { font-size: 18px; width: 24px; text-align: center; }

        /* Content */
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .content-header {
            background: var(--bg-tertiary);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-title { font-size: 18px; font-weight: 600; }
        .content-actions { display: flex; gap: 10px; }
        .content-body { flex: 1; overflow-y: auto; padding: 24px; }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .btn:hover { background: var(--bg-tertiary); border-color: var(--text-muted); }
        .btn-primary { background: var(--accent-blue); border-color: var(--accent-blue); }
        .btn-primary:hover { background: #4a9eff; }
        .btn-success { background: var(--accent-green); border-color: var(--accent-green); color: white; }
        .btn-danger { background: transparent; border-color: var(--accent-red); color: var(--accent-red); }
        .btn-danger:hover { background: var(--accent-red); color: white; }
        .btn:disabled, .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Structured Editor */
        .structured-editor { margin-top: 16px; }
        .editor-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .editor-toggle-btn {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .editor-toggle-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        .mapping-list { display: flex; flex-direction: column; gap: 8px; }
        .mapping-item {
            display: grid;
            grid-template-columns: 1fr 40px 1fr 80px 40px;
            gap: 8px;
            align-items: center;
            background: var(--bg-primary);
            padding: 8px 12px;
            border-radius: 6px;
        }
        .mapping-item input, .mapping-item select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 10px;
            color: var(--text-primary);
            font-size: 12px;
        }
        .mapping-arrow { color: var(--accent-cyan); text-align: center; }
        .mapping-remove {
            background: transparent;
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .mapping-remove:hover { background: var(--accent-red); color: white; }
        .add-mapping-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }
        .add-mapping-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        .config-field {
            display: grid;
            grid-template-columns: 150px 1fr 40px;
            gap: 8px;
            align-items: center;
            background: var(--bg-primary);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .config-field input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 10px;
            color: var(--text-primary);
            font-size: 12px;
        }

        /* BPMN Diagram */
        .bpmn-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .bpmn-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .bpmn-title { font-size: 14px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .bpmn-controls { display: flex; gap: 8px; align-items: center; }
        .bpmn-controls .btn { padding: 6px 12px; font-size: 12px; }
        .speed-control { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 12px; }
        .speed-control input { width: 80px; }

        .bpmn-canvas {
            overflow: auto;
            padding: 20px;
            position: relative;
            min-height: 200px;
        }
        .bpmn-canvas.grabbing { cursor: grabbing; }
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
            padding-left: 20px;
            border-left: 1px solid var(--border-color);
        }
        .zoom-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .zoom-btn:hover { background: var(--bg-card); border-color: var(--accent-blue); }
        .zoom-level { font-size: 12px; color: var(--text-secondary); min-width: 40px; text-align: center; }
        .bpmn-flow {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
        }

        .bpmn-row {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            gap: 0;
        }

        /* Live animation status panel */
        .animation-status {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-card));
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            display: none;
        }
        .animation-status.active { display: block; }
        .animation-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .animation-status-title {
            font-weight: 600;
            color: var(--accent-cyan);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .animation-status-title .pulse-dot {
            width: 10px;
            height: 10px;
            background: var(--accent-cyan);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        .animation-status-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .animation-status-item {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 6px;
        }
        .animation-status-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .animation-status-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* BPMN Legend */
        .bpmn-legend {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 16px;
        }
        .legend-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .legend-items {
            display: flex;
            gap: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }
        .legend-shape {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        .legend-circle {
            border-radius: 50%;
        }
        .legend-rounded {
            border-radius: 6px;
        }
        .legend-rect {
            border-radius: 3px;
        }
        .legend-diamond {
            width: 14px;
            height: 14px;
            transform: rotate(45deg);
            border-radius: 2px;
        }
        .legend-hexagon {
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            border: 2px solid var(--accent-cyan);
        }

        .bpmn-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        .bpmn-step:hover { transform: scale(1.08); }
        .bpmn-step.animating .bpmn-node { animation: nodeGlow 0.5s ease-out; }

        @keyframes nodeGlow {
            0% { box-shadow: 0 0 0 0 rgba(88,166,255,0.8); }
            100% { box-shadow: 0 0 20px 10px rgba(88,166,255,0); }
        }

        .bpmn-node {
            width: 110px;
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 18px;
            border: 2px solid var(--border-color);
            background: var(--bg-tertiary);
            transition: all 0.3s;
            position: relative;
            border-radius: 8px;
        }
        .bpmn-node .node-icon { font-size: 22px; line-height: 1; }
        .bpmn-node .node-type { font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; opacity: 0.7; }

        /* START EVENT - Circle with play icon */
        .bpmn-node.start {
            width: 55px; height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: 3px solid #0d7377;
            box-shadow: 0 4px 15px rgba(17,153,142,0.4), inset 0 2px 10px rgba(255,255,255,0.2);
        }
        .bpmn-node.start .node-icon { font-size: 24px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        /* END EVENT - Circle with thick border */
        .bpmn-node.end {
            width: 55px; height: 55px;
            border-radius: 50%;
            border-width: 4px;
        }
        .bpmn-node.end.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-color: #0a5c52;
            box-shadow: 0 4px 15px rgba(17,153,142,0.4), inset 0 2px 10px rgba(255,255,255,0.2);
        }
        .bpmn-node.end.failed {
            background: linear-gradient(135deg, #f85149 0%, #db6d28 100%);
            border-color: #a82020;
            box-shadow: 0 4px 15px rgba(248,81,73,0.4), inset 0 2px 10px rgba(255,255,255,0.2);
        }
        .bpmn-node.end .node-icon { font-size: 20px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        /* TRANSFORM - Rounded rectangle (Service Task) with gear pattern */
        .bpmn-node.transform {
            border-radius: 12px;
            background: linear-gradient(145deg, rgba(163,113,247,0.3) 0%, rgba(130,80,220,0.15) 100%);
            border: 2px solid var(--accent-purple);
            box-shadow: 0 4px 20px rgba(163,113,247,0.25), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .bpmn-node.transform::before {
            content: '';
            position: absolute;
            top: 4px; right: 4px;
            width: 16px; height: 16px;
            background: var(--accent-purple);
            border-radius: 3px;
            opacity: 0.6;
        }
        .bpmn-node.transform .node-icon { color: var(--accent-purple); }
        .bpmn-node.transform .node-type { color: var(--accent-purple); }
        .bpmn-node.transform:hover {
            box-shadow: 0 6px 30px rgba(163,113,247,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        /* API_CALL - Rectangle with cog badge (Task) */
        .bpmn-node.api-call {
            border-radius: 8px;
            background: linear-gradient(145deg, rgba(88,166,255,0.3) 0%, rgba(60,130,220,0.15) 100%);
            border: 2px solid var(--accent-blue);
            box-shadow: 0 4px 20px rgba(88,166,255,0.25), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .bpmn-node.api-call::before {
            content: 'â†—';
            position: absolute;
            top: 4px; right: 6px;
            font-size: 12px;
            color: var(--accent-blue);
            opacity: 0.8;
        }
        .bpmn-node.api-call .node-icon { color: var(--accent-blue); }
        .bpmn-node.api-call .node-type { color: var(--accent-blue); }
        .bpmn-node.api-call:hover {
            box-shadow: 0 6px 30px rgba(88,166,255,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        /* CONDITION/GATEWAY - Diamond shape */
        .bpmn-node.condition {
            width: 60px; height: 60px;
            transform: rotate(45deg);
            border-radius: 4px;
            background: linear-gradient(145deg, rgba(210,153,34,0.35) 0%, rgba(180,130,20,0.15) 100%);
            border: 3px solid var(--accent-yellow);
            box-shadow: 0 4px 20px rgba(210,153,34,0.3), inset 0 1px 0 rgba(255,255,255,0.15);
        }
        .bpmn-node.condition .node-icon {
            transform: rotate(-45deg);
            color: var(--accent-yellow);
            font-size: 20px;
            font-weight: bold;
        }
        .bpmn-node.condition .node-type { display: none; }
        .bpmn-node.condition:hover {
            box-shadow: 0 6px 30px rgba(210,153,34,0.5), inset 0 1px 0 rgba(255,255,255,0.2);
        }

        /* CALLBACK - Hexagon shape (Message Catching Event) */
        .bpmn-node.callback {
            width: 70px; height: 60px;
            background: linear-gradient(145deg, rgba(57,197,207,0.3) 0%, rgba(40,170,180,0.15) 100%);
            border: none;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            box-shadow: none;
            position: relative;
        }
        .bpmn-node.callback::before {
            content: '';
            position: absolute;
            inset: 3px;
            background: linear-gradient(145deg, rgba(57,197,207,0.4) 0%, rgba(40,170,180,0.2) 100%);
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            z-index: -1;
        }
        .bpmn-node.callback::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 3px solid var(--accent-cyan);
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            pointer-events: none;
        }
        .bpmn-node.callback .node-icon { color: var(--accent-cyan); font-size: 20px; }
        .bpmn-node.callback .node-type { display: none; }
        .bpmn-node.callback:hover {
            filter: brightness(1.15);
            transform: scale(1.05);
        }

        /* Step states - overlay on shapes */
        .bpmn-node.completed {
            border-color: var(--accent-green) !important;
            box-shadow: 0 0 20px rgba(63,185,80,0.5), inset 0 0 15px rgba(63,185,80,0.1) !important;
        }
        .bpmn-node.running {
            border-color: var(--accent-blue) !important;
            animation: pulseRunning 1.5s infinite;
        }
        .bpmn-node.failed {
            border-color: var(--accent-red) !important;
            box-shadow: 0 0 20px rgba(248,81,73,0.5), inset 0 0 15px rgba(248,81,73,0.1) !important;
        }
        .bpmn-node.waiting {
            border-color: var(--accent-yellow) !important;
            animation: pulseWaiting 2s infinite;
        }
        .bpmn-node.pending { opacity: 0.5; filter: grayscale(0.3); }

        /* Status badges - positioned via parent container */
        .status-badge {
            position: absolute;
            bottom: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 10px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .status-badge.completed { background: var(--accent-green); }
        .status-badge.failed { background: var(--accent-red); }
        .status-badge.waiting { background: var(--accent-yellow); color: #333; }
        .status-badge.running { background: var(--accent-blue); animation: pulseBadge 1s infinite; }
        @keyframes pulseBadge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Callback special position for badge */
        .bpmn-node.callback ~ .status-badge { bottom: 0; right: 0; }

        @keyframes pulseRunning {
            0%, 100% { box-shadow: 0 0 0 0 rgba(88,166,255,0.5); }
            50% { box-shadow: 0 0 15px 5px rgba(88,166,255,0.2); }
        }
        @keyframes pulseWaiting {
            0%, 100% { box-shadow: 0 0 0 0 rgba(210,153,34,0.5); }
            50% { box-shadow: 0 0 15px 5px rgba(210,153,34,0.2); }
        }

        .step-label {
            margin-top: 12px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            max-width: 110px;
            text-align: center;
            line-height: 1.3;
        }
        .step-status {
            font-size: 9px;
            padding: 3px 10px;
            border-radius: 12px;
            margin-top: 6px;
            background: var(--bg-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .step-status.COMPLETED { background: rgba(63,185,80,0.2); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .step-status.FAILED { background: rgba(248,81,73,0.2); color: var(--accent-red); border: 1px solid var(--accent-red); }
        .step-status.WAITING { background: rgba(210,153,34,0.2); color: var(--accent-yellow); border: 1px solid var(--accent-yellow); }
        .step-status.RUNNING, .step-status.IN_PROGRESS { background: rgba(88,166,255,0.2); color: var(--accent-blue); border: 1px solid var(--accent-blue); }
        .step-status.PENDING { background: rgba(139,148,158,0.2); color: var(--text-muted); border: 1px solid var(--border-color); }

        /* Arrows */
        .bpmn-arrow {
            width: 50px;
            height: 3px;
            background: var(--border-color);
            position: relative;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        .bpmn-arrow::after {
            content: '';
            position: absolute;
            right: -1px;
            top: -5px;
            border: 6px solid transparent;
            border-left-color: var(--border-color);
            transition: all 0.3s;
        }
        .bpmn-arrow.active { background: var(--accent-green); }
        .bpmn-arrow.active::after { border-left-color: var(--accent-green); }
        .bpmn-arrow.animating {
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue));
            box-shadow: 0 0 15px var(--accent-cyan);
        }
        .bpmn-arrow.animating::after { border-left-color: var(--accent-cyan); }
        .bpmn-arrow.visited {
            background: var(--accent-cyan);
            box-shadow: 0 0 8px rgba(57, 197, 207, 0.5);
        }
        .bpmn-arrow.visited::after { border-left-color: var(--accent-cyan); }
        .bpmn-step.visited .bpmn-node {
            box-shadow: 0 0 15px rgba(57, 197, 207, 0.6);
            border-color: var(--accent-cyan);
        }

        /* Animation pulse traveling through arrow */
        .bpmn-arrow .pulse {
            position: absolute;
            width: 16px;
            height: 16px;
            background: radial-gradient(circle, #fff 0%, var(--accent-cyan) 50%, transparent 100%);
            border-radius: 50%;
            top: -7px;
            left: -8px;
            opacity: 0;
            box-shadow: 0 0 20px var(--accent-cyan), 0 0 40px var(--accent-cyan);
            z-index: 10;
        }
        .bpmn-arrow.animating .pulse {
            animation: travelPulse var(--pulse-speed, 0.6s) ease-in-out forwards;
        }
        @keyframes travelPulse {
            0% { left: -8px; opacity: 0; transform: scale(0.5); }
            10% { opacity: 1; transform: scale(1); }
            90% { opacity: 1; transform: scale(1); }
            100% { left: calc(100% - 8px); opacity: 0; transform: scale(0.5); }
        }

        /* Glowing trail effect */
        .bpmn-arrow.animating::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 0;
            height: 5px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), var(--accent-cyan));
            animation: trailGrow var(--pulse-speed, 0.6s) ease-in-out forwards;
            box-shadow: 0 0 10px var(--accent-cyan);
        }
        @keyframes trailGrow {
            0% { width: 0; }
            100% { width: 100%; }
        }

        /* Step highlight during animation */
        .bpmn-step.animating .bpmn-node {
            animation: nodeHighlight 0.5s ease-out forwards;
        }
        @keyframes nodeHighlight {
            0% {
                box-shadow: 0 0 0 0 rgba(57, 197, 207, 0.8);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 30px 15px rgba(57, 197, 207, 0.4);
                transform: scale(1.1);
            }
            100% {
                box-shadow: 0 0 20px 5px rgba(57, 197, 207, 0.2);
                transform: scale(1);
            }
        }

        /* Info Grid */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }
        .info-card-title { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-secondary); }
        .info-value { font-weight: 500; }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-success { background: var(--accent-green); color: white; }
        .badge-pending { background: var(--text-muted); color: white; }
        .badge-running { background: var(--accent-blue); color: white; }
        .badge-waiting { background: var(--accent-yellow); color: black; }
        .badge-failed { background: var(--accent-red); color: white; }
        .badge-timeout { background: var(--accent-orange); color: white; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        .step-tab-content { margin-top: 16px; }

        /* Debug Panel */
        .debug-panel { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; }
        .debug-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .debug-content { max-height: 500px; overflow-y: auto; }
        .debug-entry {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }
        .debug-entry:hover { background: var(--bg-tertiary); }
        .debug-entry:last-child { border-bottom: none; }
        .debug-entry-header { display: flex; align-items: center; gap: 12px; }
        .debug-num {
            width: 28px; height: 28px;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        .debug-name { flex: 1; font-weight: 500; }
        .debug-type { font-size: 11px; padding: 3px 10px; border-radius: 12px; background: var(--bg-primary); color: var(--text-muted); }
        .debug-details {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-primary);
            border-radius: 8px;
        }
        .debug-entry.expanded .debug-details { display: block; }
        .debug-section { margin-bottom: 16px; }
        .debug-section:last-child { margin-bottom: 0; }
        .debug-section-title { font-size: 11px; color: var(--accent-blue); text-transform: uppercase; margin-bottom: 8px; }
        .debug-json {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .stat-value { font-size: 32px; font-weight: 700; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { color: var(--text-muted); font-size: 12px; margin-top: 4px; }
        .stat-card.success { border-color: rgba(63,185,80,0.3); background: linear-gradient(135deg, rgba(63,185,80,0.1) 0%, var(--bg-card) 100%); }
        .stat-card.success .stat-value { background: var(--gradient-2); -webkit-background-clip: text; }
        .stat-card.error { border-color: rgba(248,81,73,0.3); background: linear-gradient(135deg, rgba(248,81,73,0.1) 0%, var(--bg-card) 100%); }
        .stat-card.error .stat-value { background: var(--gradient-3); -webkit-background-clip: text; }
        .stat-card.warning { border-color: rgba(210,153,34,0.3); background: linear-gradient(135deg, rgba(210,153,34,0.1) 0%, var(--bg-card) 100%); }
        .stat-card.warning .stat-value { color: var(--accent-yellow); -webkit-text-fill-color: var(--accent-yellow); }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }
        .data-table td { padding: 12px 16px; border: 1px solid var(--border-color); }
        .data-table tr:hover td { background: var(--bg-card); }
        .clickable { color: var(--accent-blue); cursor: pointer; text-decoration: underline; }
        .clickable:hover { color: var(--accent-cyan); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalIn 0.2s ease-out;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 28px; cursor: pointer; line-height: 1; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }

        /* Flow Setup */
        .flow-setup-grid { display: grid; grid-template-columns: 300px 1fr; gap: 24px; height: calc(100vh - 250px); }
        .flow-list {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        .flow-list-header { padding: 16px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .flow-list-items { overflow-y: auto; max-height: calc(100% - 60px); }
        .flow-list-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }
        .flow-list-item:hover { background: var(--bg-tertiary); }
        .flow-list-item.active { background: var(--bg-tertiary); border-left: 3px solid var(--accent-blue); }
        .flow-list-item h4 { margin-bottom: 4px; }
        .flow-list-item p { font-size: 12px; color: var(--text-muted); }

        .flow-editor {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .flow-editor-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .flow-editor-canvas { flex: 1; padding: 24px; overflow: auto; }
        .flow-step-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .flow-step-card:hover { border-color: var(--accent-blue); }
        .flow-step-num { width: 32px; height: 32px; background: var(--accent-blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .flow-step-info { flex: 1; }
        .flow-step-name { font-weight: 500; margin-bottom: 4px; }
        .flow-step-type { font-size: 12px; color: var(--text-muted); }

        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--text-secondary); }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border-color); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Empty State */
        .empty-state { text-align: center; padding: 80px 20px; color: var(--text-secondary); }
        .empty-icon { font-size: 64px; margin-bottom: 20px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }

        /* Timeline */
        .timeline { padding-left: 30px; position: relative; }
        .timeline::before { content: ''; position: absolute; left: 12px; top: 0; bottom: 0; width: 2px; background: var(--border-color); }
        .timeline-item { position: relative; padding-bottom: 24px; }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: 2px solid var(--bg-card);
        }
        .timeline-item.success::before { background: var(--accent-green); }
        .timeline-item.error::before { background: var(--accent-red); }
        .timeline-item.warning::before { background: var(--accent-yellow); }
        .timeline-time { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
        .timeline-content { background: var(--bg-tertiary); padding: 16px; border-radius: 8px; border: 1px solid var(--border-color); }

        /* ============================================ */
        /* VISUAL FLOW BUILDER STYLES                  */
        /* ============================================ */
        .builder-container {
            display: grid;
            grid-template-columns: 220px 1fr 320px;
            gap: 16px;
            height: calc(100vh - 180px);
            min-height: 600px;
        }

        /* Step Palette */
        .builder-palette {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            overflow-y: auto;
        }
        .palette-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .palette-section {
            margin-bottom: 20px;
        }
        .palette-section-title {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .palette-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
        }
        .palette-item:hover {
            border-color: var(--accent-blue);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .palette-item:active { cursor: grabbing; }
        .palette-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .palette-item-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 16px;
            flex-shrink: 0;
        }
        .palette-item-icon.start { background: linear-gradient(135deg, #11998e, #38ef7d); border-radius: 50%; }
        .palette-item-icon.end { background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; }
        .palette-item-icon.transform { background: rgba(163,113,247,0.3); border: 2px solid var(--accent-purple); }
        .palette-item-icon.api-call { background: rgba(88,166,255,0.3); border: 2px solid var(--accent-blue); }
        .palette-item-icon.condition { background: rgba(210,153,34,0.3); border: 2px solid var(--accent-yellow); transform: rotate(45deg); width: 28px; height: 28px; }
        .palette-item-icon.condition span { transform: rotate(-45deg); }
        .palette-item-icon.callback { background: rgba(57,197,207,0.3); border: 2px solid var(--accent-cyan); clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); }
        .palette-item-info {
            flex: 1;
            min-width: 0;
        }
        .palette-item-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
        }
        .palette-item-desc {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Canvas */
        .builder-canvas {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        .canvas-toolbar {
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            pointer-events: none;
        }
        .canvas-toolbar > * { pointer-events: auto; }
        .canvas-toolbar-left, .canvas-toolbar-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .canvas-flow-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 13px;
            min-width: 200px;
        }
        .canvas-btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .canvas-btn:hover { background: var(--bg-tertiary); border-color: var(--accent-blue); }
        .canvas-btn.primary { background: var(--accent-blue); border-color: var(--accent-blue); color: white; }
        .canvas-btn.primary:hover { background: #4a9eff; }
        .canvas-btn.success { background: var(--accent-green); border-color: var(--accent-green); color: white; }
        .canvas-btn.danger { background: var(--accent-red); border-color: var(--accent-red); color: white; }

        .canvas-area {
            position: absolute;
            inset: 60px 12px 12px 12px;
            background:
                radial-gradient(circle at center, rgba(88,166,255,0.03) 0%, transparent 70%),
                linear-gradient(90deg, var(--border-color) 1px, transparent 1px),
                linear-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 100% 100%, 30px 30px, 30px 30px;
            border-radius: 8px;
            overflow: auto;
        }
        .canvas-area.drag-over {
            background-color: rgba(88,166,255,0.05);
            box-shadow: inset 0 0 30px rgba(88,166,255,0.1);
        }

        .canvas-inner {
            position: relative;
            min-width: 100%;
            min-height: 100%;
            padding: 40px;
        }

        /* Canvas Nodes */
        .canvas-node {
            position: absolute;
            cursor: move;
            user-select: none;
            transition: box-shadow 0.2s;
        }
        .canvas-node:hover { z-index: 100; }
        .canvas-node.selected {
            z-index: 101;
        }
        .canvas-node.selected .node-body {
            box-shadow: 0 0 0 3px var(--accent-blue), 0 8px 25px rgba(0,0,0,0.3);
        }
        .canvas-node.dragging {
            opacity: 0.8;
            z-index: 1000;
        }

        .node-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        /* Node shapes */
        .node-body.start, .node-body.end {
            width: 60px;
            height: 60px;
            border-radius: 50%;
        }
        .node-body.start {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: 3px solid #0d7377;
            box-shadow: 0 4px 15px rgba(17,153,142,0.4);
        }
        .node-body.end {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 4px solid #5a67d8;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .node-body.transform {
            width: 140px;
            height: 70px;
            border-radius: 12px;
            background: linear-gradient(145deg, rgba(163,113,247,0.3), rgba(130,80,220,0.15));
            border: 2px solid var(--accent-purple);
            box-shadow: 0 4px 20px rgba(163,113,247,0.25);
        }

        .node-body.api-call {
            width: 140px;
            height: 70px;
            border-radius: 8px;
            background: linear-gradient(145deg, rgba(88,166,255,0.3), rgba(60,130,220,0.15));
            border: 2px solid var(--accent-blue);
            box-shadow: 0 4px 20px rgba(88,166,255,0.25);
        }

        .node-body.condition {
            width: 70px;
            height: 70px;
            transform: rotate(45deg);
            border-radius: 8px;
            background: linear-gradient(145deg, rgba(210,153,34,0.35), rgba(180,130,20,0.15));
            border: 3px solid var(--accent-yellow);
            box-shadow: 0 4px 20px rgba(210,153,34,0.3);
        }
        .node-body.condition .node-content { transform: rotate(-45deg); }

        .node-body.callback {
            width: 80px;
            height: 70px;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            background: linear-gradient(145deg, rgba(57,197,207,0.4), rgba(40,170,180,0.2));
            border: none;
            position: relative;
        }
        .node-body.callback::before {
            content: '';
            position: absolute;
            inset: 3px;
            background: linear-gradient(145deg, rgba(57,197,207,0.3), rgba(40,170,180,0.15));
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
        }

        .node-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            text-align: center;
            padding: 8px;
            position: relative;
            z-index: 1;
        }
        .node-icon { font-size: 20px; }
        .node-body.start .node-icon, .node-body.end .node-icon { color: white; font-size: 24px; }
        .node-body.transform .node-icon { color: var(--accent-purple); }
        .node-body.api-call .node-icon { color: var(--accent-blue); }
        .node-body.condition .node-icon { color: var(--accent-yellow); }
        .node-body.callback .node-icon { color: var(--accent-cyan); }
        .node-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-primary);
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .node-body.start .node-label, .node-body.end .node-label { display: none; }
        .node-body.condition .node-label { display: none; }

        .node-label-external {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            text-align: center;
            background: var(--bg-card);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* Connection ports */
        .node-port {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            cursor: crosshair;
            z-index: 10;
            transition: all 0.2s;
        }
        .node-port:hover {
            transform: scale(1.3);
            border-color: var(--accent-blue);
            background: var(--accent-blue);
        }
        .node-port.connecting {
            background: var(--accent-green);
            border-color: var(--accent-green);
            animation: portPulse 0.5s infinite;
        }
        @keyframes portPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(63,185,80,0.5); }
            50% { box-shadow: 0 0 0 6px rgba(63,185,80,0); }
        }
        .node-port.input { left: -7px; top: 50%; transform: translateY(-50%); }
        .node-port.output { right: -7px; top: 50%; transform: translateY(-50%); }
        .node-body.condition .node-port.input { left: auto; right: auto; top: -7px; left: 50%; transform: translateX(-50%) rotate(-45deg); }
        .node-body.condition .node-port.output { left: auto; right: auto; bottom: -7px; left: 50%; transform: translateX(-50%) rotate(-45deg); top: auto; }
        .node-body.condition .node-port.output-yes { right: -7px; top: 50%; transform: translateY(-50%) rotate(-45deg); left: auto; bottom: auto; }
        .node-body.condition .node-port.output-no { left: -7px; top: 50%; transform: translateY(-50%) rotate(-45deg); right: auto; bottom: auto; }

        /* Connection delete button */
        .node-delete {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent-red);
            color: white;
            border: 2px solid var(--bg-card);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 20;
        }
        .canvas-node:hover .node-delete { display: flex; }
        .canvas-node.start .node-delete, .canvas-node.end .node-delete { display: none !important; }

        /* SVG Connections */
        .connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        .connection-line {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 3;
            pointer-events: stroke;
            cursor: pointer;
            transition: all 0.2s;
        }
        .connection-line-hitarea {
            fill: none;
            stroke: transparent;
            stroke-width: 20;
            pointer-events: stroke;
            cursor: pointer;
        }
        .connection-line:hover, .connection-line-hitarea:hover + .connection-line {
            stroke: var(--accent-red);
            stroke-width: 4;
            filter: drop-shadow(0 0 4px var(--accent-red));
        }
        .connection-line.active {
            stroke: var(--accent-green);
            stroke-width: 3;
        }
        .connection-arrow {
            fill: var(--border-color);
            pointer-events: none;
        }
        .connection-line.active + .connection-arrow { fill: var(--accent-green); }
        .connection-delete-btn {
            cursor: pointer;
            pointer-events: all;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .connection-group:hover .connection-delete-btn {
            opacity: 1;
        }
        .connection-preview {
            fill: none;
            stroke: var(--accent-blue);
            stroke-width: 3;
            stroke-dasharray: 8, 4;
            pointer-events: none;
            opacity: 0.8;
            animation: dash-flow 0.5s linear infinite;
        }
        @keyframes dash-flow {
            to { stroke-dashoffset: -12; }
        }
        .node-port.valid-target {
            background: var(--accent-blue) !important;
            box-shadow: 0 0 8px var(--accent-blue), 0 0 15px rgba(88, 166, 255, 0.4);
            transform: scale(1.3);
            animation: pulse-port 0.8s ease-in-out infinite;
        }
        .node-port.hover-target {
            background: var(--accent-green) !important;
            box-shadow: 0 0 12px var(--accent-green), 0 0 20px rgba(46, 204, 113, 0.5);
            transform: scale(1.5);
        }
        @keyframes pulse-port {
            0%, 100% { transform: scale(1.3); }
            50% { transform: scale(1.5); }
        }

        /* Properties Panel */
        .builder-properties {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .properties-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .properties-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            padding: 40px 20px;
        }
        .properties-empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .properties-empty-text { font-size: 13px; }

        .properties-form { flex: 1; }
        .prop-group {
            margin-bottom: 16px;
        }
        .prop-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .prop-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }
        .prop-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88,166,255,0.1);
        }
        .prop-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }
        .prop-textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            resize: vertical;
        }
        .prop-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .prop-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .prop-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .prop-section-header {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .prop-section-header:hover { background: var(--bg-card); }
        .prop-section-body {
            padding: 12px;
        }
        .prop-section.collapsed .prop-section-body { display: none; }

        /* Flow info header in properties */
        .flow-info-card {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .flow-info-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .flow-info-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Empty canvas state */
        .canvas-empty {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            pointer-events: none;
        }
        .canvas-empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
        .canvas-empty-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
        .canvas-empty-text { font-size: 13px; max-width: 300px; line-height: 1.5; }

        /* Mini map */
        .canvas-minimap {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 150px;
            height: 100px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            opacity: 0.8;
            overflow: hidden;
            z-index: 50;
        }
        .canvas-minimap:hover { opacity: 1; }

        /* Connection type badges */
        .connection-type-badge {
            position: absolute;
            padding: 2px 6px;
            font-size: 9px;
            font-weight: 600;
            border-radius: 4px;
            pointer-events: none;
        }
        .connection-type-badge.yes { background: var(--accent-green); color: white; }
        .connection-type-badge.no { background: var(--accent-red); color: white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <span class="logo">Orchestrator Troubleshooter</span>
            <span class="author">v2.0 by Gashie</span>
        </div>
        <div class="header-status">
            <div class="status-item">
                <div class="status-dot" id="dbStatus"></div>
                <span id="dbStatusText">Connecting...</span>
            </div>
            <div class="status-item"><span id="problemCount">-</span> issues</div>
        </div>
    </div>

    <div class="search-bar">
        <input type="text" class="search-input" id="searchInput" placeholder="Search by Session ID, Tracking Number, or Instance ID..." autofocus>
        <button class="btn-search" onclick="searchFlow()">Search Flow</button>
    </div>

    <div class="main">
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Overview</div>
                <div class="sidebar-item active" data-view="dashboard" onclick="showView('dashboard')">
                    <span class="sidebar-icon">ðŸ“Š</span><span>Dashboard</span>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Flows</div>
                <div class="sidebar-item" data-view="recent" onclick="showView('recent')">
                    <span class="sidebar-icon">ðŸ“‹</span><span>Recent Flows</span>
                </div>
                <div class="sidebar-item" data-view="stuck" onclick="showView('stuck')">
                    <span class="sidebar-icon">â¸ï¸</span><span>Stuck Flows</span>
                </div>
                <div class="sidebar-item" data-view="failed" onclick="showView('failed')">
                    <span class="sidebar-icon">âŒ</span><span>Failed Flows</span>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Callbacks</div>
                <div class="sidebar-item" data-view="timedout" onclick="showView('timedout')">
                    <span class="sidebar-icon">â°</span><span>Timed Out</span>
                </div>
                <div class="sidebar-item" data-view="spam" onclick="showView('spam')">
                    <span class="sidebar-icon">ðŸ“¢</span><span>Callback Spam</span>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Configuration</div>
                <div class="sidebar-item" data-view="builder" onclick="showView('builder')">
                    <span class="sidebar-icon">ðŸŽ¨</span><span>Visual Builder</span>
                    <span style="font-size:9px;background:var(--accent-purple);color:white;padding:2px 6px;border-radius:8px;margin-left:auto;">NEW</span>
                </div>
                <div class="sidebar-item" data-view="setup" onclick="showView('setup')">
                    <span class="sidebar-icon">âš™ï¸</span><span>Flow Setup</span>
                </div>
                <div class="sidebar-item" data-view="events" onclick="showView('events')">
                    <span class="sidebar-icon">ðŸ“</span><span>Event Types</span>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">System</div>
                <div class="sidebar-item" data-view="jobs" onclick="showView('jobs')">
                    <span class="sidebar-icon">ðŸ”„</span><span>Job Queue</span>
                </div>
                <div class="sidebar-item" data-view="configs" onclick="showView('configs')">
                    <span class="sidebar-icon">ðŸ”§</span><span>System Config</span>
                </div>
                <div class="sidebar-item" data-view="logs" onclick="showView('logs')">
                    <span class="sidebar-icon">ðŸ“œ</span><span>Process Logs</span>
                </div>
                <div class="sidebar-item" data-view="guide" onclick="showView('guide')">
                    <span class="sidebar-icon">ðŸ“–</span><span>Guide</span>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="content-header">
                <span class="content-title" id="viewTitle">Dashboard</span>
                <div class="content-actions" id="viewActions"></div>
            </div>
            <div class="content-body" id="contentBody"></div>
        </div>
    </div>

    <!-- Step Details Modal -->
    <div class="modal-overlay" id="stepModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Step Details</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3333/api';
        let currentFlow = null;
        let currentSteps = [];
        let animationInterval = null;
        let animationSpeed = 800;

        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            showView('dashboard');
            document.getElementById('searchInput').addEventListener('keydown', e => { if (e.key === 'Enter') searchFlow(); });
        });

        async function checkHealth() {
            try {
                const res = await fetch(`${API}/health`);
                const data = await res.json();
                document.getElementById('dbStatus').className = `status-dot ${data.success ? '' : 'error'}`;
                document.getElementById('dbStatusText').textContent = data.success ? 'Connected' : 'Disconnected';

                const stats = await (await fetch(`${API}/stats`)).json();
                if (stats.success) document.getElementById('problemCount').textContent = stats.data.problems + stats.data.stuck;
            } catch (err) {
                document.getElementById('dbStatus').className = 'status-dot error';
                document.getElementById('dbStatusText').textContent = 'Offline';
            }
        }

        function showView(view) {
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.toggle('active', i.dataset.view === view));
            const handlers = {
                dashboard: loadDashboard, recent: loadRecentFlows, stuck: loadStuckFlows,
                failed: loadFailedFlows, timedout: loadTimedOutCallbacks, spam: loadCallbackSpam,
                jobs: loadJobQueue, guide: showGuide, setup: showFlowSetup, events: showEventTypes,
                builder: showVisualBuilder, configs: showSystemConfigs, logs: showProcessLogs
            };
            if (handlers[view]) handlers[view]();
        }

        async function searchFlow() {
            const q = document.getElementById('searchInput').value.trim();
            if (!q) return;
            setLoading();
            setTitle('Flow Analysis');

            try {
                const res = await fetch(`${API}/flow/${encodeURIComponent(q)}`);
                const data = await res.json();
                if (!data.success) { setContent(`<div class="empty-state"><div class="empty-icon">ðŸ”</div><h3>Flow Not Found</h3><p>No flow found for: ${q}</p></div>`); return; }
                currentFlow = data.data;
                await loadFlowAnalysis(data.data);
            } catch (err) {
                setContent(`<div class="empty-state"><div class="empty-icon">âŒ</div><h3>Error</h3><p>${err.message}</p></div>`);
            }
        }

        async function loadFlowAnalysis(flow) {
            setTitle(`Flow: ${flow.session_id}`);
            setActions(`<button class="btn" onclick="refreshFlow('${flow.id}')">Refresh</button>${flow.status === 'WAITING_CALLBACK' ? `<button class="btn btn-success" onclick="resumeFlow('${flow.id}')">Resume</button>` : ''}`);

            const [stepsRes, cbRes] = await Promise.all([fetch(`${API}/flow/${flow.id}/steps`), fetch(`${API}/flow/${flow.id}/callbacks`)]);
            currentSteps = (await stepsRes.json()).data || [];
            const callbacks = (await cbRes.json()).data || [];

            setContent(`
                <div class="bpmn-container">
                    <div class="bpmn-header">
                        <span class="bpmn-title">Flow Execution Path</span>
                        <div class="bpmn-controls">
                            <button class="btn btn-primary" id="playBtn" onclick="playAnimation()">â–¶ Play</button>
                            <button class="btn" onclick="resetAnimation()">â†º Reset</button>
                            <div class="speed-control">
                                <span>ðŸ¢</span>
                                <input type="range" min="300" max="1500" value="800" id="speedSlider" oninput="updateSpeed(this.value)" title="Animation Speed">
                                <span>ðŸ‡</span>
                                <span id="speedLabel" style="min-width:60px">1.0x</span>
                            </div>
                            <div class="zoom-controls">
                                <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">âˆ’</button>
                                <span class="zoom-level" id="zoomLevel">100%</span>
                                <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
                                <button class="zoom-btn" onclick="zoomReset()" title="Reset Zoom">âŸ²</button>
                            </div>
                        </div>
                    </div>
                    <div class="bpmn-canvas"><div class="bpmn-flow" id="bpmnFlow"></div></div>
                    <div class="bpmn-legend">
                        <div class="legend-title">BPMN Legend</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-shape legend-circle" style="background:linear-gradient(135deg, #11998e, #38ef7d);"></div>
                                <span>Start/End Event</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-shape legend-rounded" style="background:rgba(163,113,247,0.3);border:2px solid var(--accent-purple);"></div>
                                <span>Transform (Service)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-shape legend-rect" style="background:rgba(88,166,255,0.3);border:2px solid var(--accent-blue);"></div>
                                <span>API Call (Task)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-shape legend-diamond" style="background:rgba(210,153,34,0.3);border:2px solid var(--accent-yellow);"></div>
                                <span>Gateway (Decision)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-shape legend-hexagon" style="background:rgba(57,197,207,0.3);"></div>
                                <span>Callback (Event)</span>
                            </div>
                        </div>
                    </div>
                    <div class="animation-status" id="animationStatus">
                        <div class="animation-status-header">
                            <div class="animation-status-title"><div class="pulse-dot"></div><span id="animStatusTitle">Processing...</span></div>
                            <span id="animProgress" style="color:var(--text-muted);font-size:12px">Step 0 / ${currentSteps.length}</span>
                        </div>
                        <div class="animation-status-content">
                            <div class="animation-status-item">
                                <div class="animation-status-label">Current Step</div>
                                <div class="animation-status-value" id="animCurrentStep">-</div>
                            </div>
                            <div class="animation-status-item">
                                <div class="animation-status-label">Step Type</div>
                                <div class="animation-status-value" id="animStepType">-</div>
                            </div>
                            <div class="animation-status-item">
                                <div class="animation-status-label">Action</div>
                                <div class="animation-status-value" id="animAction">-</div>
                            </div>
                            <div class="animation-status-item">
                                <div class="animation-status-label">Result</div>
                                <div class="animation-status-value" id="animResult">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                ${buildInfoCards(flow, callbacks)}
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(this, 'debug')">Step Execution</div>
                    <div class="tab" onclick="switchTab(this, 'callbacks')">Callbacks</div>
                    <div class="tab" onclick="switchTab(this, 'payload')">Payload</div>
                </div>
                <div id="tab-debug">${buildDebugPanel(currentSteps)}</div>
                <div id="tab-callbacks" style="display:none;">${buildTimeline(callbacks)}</div>
                <div id="tab-payload" style="display:none;"><div class="debug-panel"><div class="debug-header">Current Payload</div><div class="debug-content"><pre class="debug-json">${JSON.stringify(safeJSON(flow.current_payload), null, 2)}</pre></div></div></div>
            `);
            renderBpmn(currentSteps, flow);
        }

        function renderBpmn(steps, flow) {
            const container = document.getElementById('bpmnFlow');
            if (!container) return;
            container.innerHTML = '';

            // Start node
            container.innerHTML += `
                <div class="bpmn-step" data-step="start" onclick="showStartDetails()">
                    <div class="bpmn-node start">
                        <span class="node-icon">â–¶</span>
                    </div>
                    <div class="step-label">Start</div>
                </div>`;
            container.innerHTML += `<div class="bpmn-arrow ${steps.length > 0 && steps[0].status === 'COMPLETED' ? 'active' : ''}" data-arrow="0"><div class="pulse"></div></div>`;

            steps.forEach((step, i) => {
                const nodeClass = getNodeClass(step);
                const statusClass = getStatusClass(step.status);
                const isCondition = step.step_type === 'CONDITION' || step.step_type === 'GATEWAY';
                const isCallback = step.step_type === 'CALLBACK' || step.step_type === 'LISTENER';

                // Get status badge content
                let badgeContent = '';
                if (step.status === 'COMPLETED') badgeContent = 'âœ“';
                else if (step.status === 'FAILED') badgeContent = 'âœ•';
                else if (step.status === 'WAITING') badgeContent = 'â³';
                else if (step.status === 'RUNNING' || step.status === 'IN_PROGRESS') badgeContent = 'â—';

                container.innerHTML += `
                    <div class="bpmn-step" data-step="${i}" onclick="showStepModal(${i})">
                        <div class="bpmn-node ${nodeClass} ${statusClass}">
                            <span class="node-icon">${getStepIcon(step.step_type)}</span>
                            ${!isCondition && !isCallback ? `<span class="node-type">${getStepTypeLabel(step.step_type)}</span>` : ''}
                        </div>
                        ${badgeContent ? `<div class="status-badge ${statusClass}">${badgeContent}</div>` : ''}
                        <div class="step-label">${step.step_code.replace(/^FT_/, '').replace(/_/g, ' ')}</div>
                        <div class="step-status ${step.status}">${step.status}</div>
                    </div>
                `;
                if (i < steps.length - 1) {
                    const active = step.status === 'COMPLETED' ? 'active' : '';
                    container.innerHTML += `<div class="bpmn-arrow ${active}" data-arrow="${i+1}"><div class="pulse"></div></div>`;
                }
            });

            // End node
            if (flow.status === 'COMPLETED' || flow.status === 'FAILED') {
                container.innerHTML += `<div class="bpmn-arrow ${flow.status === 'COMPLETED' ? 'active' : ''}" data-arrow="end"><div class="pulse"></div></div>`;
                container.innerHTML += `
                    <div class="bpmn-step">
                        <div class="bpmn-node end ${flow.status === 'COMPLETED' ? 'success' : 'failed'}">
                            <span class="node-icon">${flow.status === 'COMPLETED' ? 'â—‰' : 'â—‰'}</span>
                        </div>
                        <div class="step-label">${flow.status}</div>
                    </div>`;
            }
        }

        let currentAnimStep = -1;
        let isPlaying = false;

        function playAnimation() {
            const btn = document.getElementById('playBtn');

            // Toggle pause/play
            if (isPlaying) {
                pauseAnimation();
                return;
            }

            isPlaying = true;
            btn.innerHTML = 'â¸ Pause';
            btn.style.background = 'var(--accent-yellow)';

            // Show animation status panel
            const statusPanel = document.getElementById('animationStatus');
            if (statusPanel) statusPanel.classList.add('active');

            // Reset if at end
            if (currentAnimStep >= currentSteps.length) {
                resetAnimation();
            }

            // Set CSS variable for animation speed
            document.documentElement.style.setProperty('--pulse-speed', (animationSpeed * 0.7) + 'ms');

            animationInterval = setInterval(() => {
                currentAnimStep++;
                if (currentAnimStep > currentSteps.length) {
                    stopAnimation();
                    updateAnimationStatus(null, true); // Show completion
                    return;
                }
                animateStep(currentAnimStep);
            }, animationSpeed);

            // Animate first step immediately
            if (currentAnimStep === -1) {
                currentAnimStep = 0;
                animateStep(0);
            }
        }

        function pauseAnimation() {
            isPlaying = false;
            const btn = document.getElementById('playBtn');
            btn.innerHTML = 'â–¶ Resume';
            btn.style.background = 'var(--gradient-1)';
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
        }

        function stopAnimation() {
            isPlaying = false;
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            const btn = document.getElementById('playBtn');
            if (btn) {
                btn.innerHTML = 'â–¶ Play';
                btn.style.background = 'var(--gradient-1)';
            }
        }

        function resetAnimation() {
            stopAnimation();
            currentAnimStep = -1;
            document.querySelectorAll('.bpmn-step').forEach(s => s.classList.remove('animating', 'visited'));
            document.querySelectorAll('.bpmn-arrow').forEach(a => a.classList.remove('animating', 'visited'));
            // Hide animation status
            const statusPanel = document.getElementById('animationStatus');
            if (statusPanel) statusPanel.classList.remove('active');
        }

        function updateAnimationStatus(step, completed = false) {
            const statusTitle = document.getElementById('animStatusTitle');
            const progress = document.getElementById('animProgress');
            const currentStepEl = document.getElementById('animCurrentStep');
            const stepTypeEl = document.getElementById('animStepType');
            const actionEl = document.getElementById('animAction');
            const resultEl = document.getElementById('animResult');

            if (completed) {
                statusTitle.textContent = 'Animation Complete';
                progress.textContent = `${currentSteps.length} / ${currentSteps.length}`;
                return;
            }

            if (!step) {
                statusTitle.textContent = 'Starting flow...';
                currentStepEl.textContent = 'Initializing';
                stepTypeEl.textContent = 'START';
                actionEl.textContent = 'Loading request payload';
                resultEl.textContent = '-';
                progress.textContent = `0 / ${currentSteps.length}`;
                return;
            }

            progress.textContent = `Step ${currentAnimStep + 1} / ${currentSteps.length}`;
            currentStepEl.textContent = step.step_code;
            stepTypeEl.textContent = step.step_type;

            // Describe what this step is doing
            const actions = {
                'TRANSFORM': 'Transforming payload fields...',
                'API_CALL': 'Calling external API...',
                'CONDITION': 'Evaluating response codes...',
                'CALLBACK': 'Waiting for callback...',
                'LISTENER': 'Listening for response...'
            };
            actionEl.textContent = actions[step.step_type] || 'Processing...';

            // Show result
            if (step.action_code) {
                const color = step.action_code === '000' ? 'var(--accent-green)' : 'var(--accent-red)';
                resultEl.innerHTML = `<span style="color:${color}">${step.action_code}</span> ${getActionMeaning(step.action_code)}`;
            } else if (step.status === 'COMPLETED') {
                resultEl.innerHTML = '<span style="color:var(--accent-green)">âœ“ Success</span>';
            } else if (step.status === 'FAILED') {
                resultEl.innerHTML = '<span style="color:var(--accent-red)">âœ— Failed</span>';
            } else {
                resultEl.textContent = step.status || '-';
            }
        }

        function animateStep(idx) {
            // Keep previous steps highlighted as 'visited'
            document.querySelectorAll('.bpmn-step.animating').forEach(s => {
                s.classList.remove('animating');
                s.classList.add('visited');
            });
            document.querySelectorAll('.bpmn-arrow.animating').forEach(a => {
                a.classList.remove('animating');
                a.classList.add('visited');
            });

            // Animate arrow first
            const arrow = document.querySelector(`.bpmn-arrow[data-arrow="${idx}"]`);
            if (arrow) {
                // Force animation restart
                arrow.classList.remove('animating');
                void arrow.offsetWidth; // Trigger reflow
                arrow.classList.add('animating');

                // Re-trigger pulse animation
                const pulse = arrow.querySelector('.pulse');
                if (pulse) {
                    pulse.style.animation = 'none';
                    void pulse.offsetHeight; // Trigger reflow
                    pulse.style.animation = null;
                }
            }

            // Animate start node at beginning
            if (idx === 0) {
                const startNode = document.querySelector('.bpmn-step[data-step="start"]');
                if (startNode) {
                    startNode.classList.add('animating');
                }
                updateAnimationStatus(null); // Show start status
            }

            // Update animation status with current step info
            const currentStep = currentSteps[idx];
            if (currentStep) {
                updateAnimationStatus(currentStep);
            }

            // Then animate step after half the arrow animation
            setTimeout(() => {
                const step = document.querySelector(`.bpmn-step[data-step="${idx}"]`);
                if (step) {
                    step.classList.remove('animating');
                    void step.offsetWidth;
                    step.classList.add('animating');
                }

                // Animate end node if this is the last step
                if (idx === currentSteps.length) {
                    const endNode = document.querySelector('.bpmn-step:last-child');
                    if (endNode) {
                        endNode.classList.add('animating');
                    }
                }
            }, animationSpeed * 0.5);
        }

        function showStepModal(idx) {
            const step = currentSteps[idx];
            if (!step) return;

            document.getElementById('modalTitle').textContent = step.step_code;
            document.getElementById('modalBody').innerHTML = `
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-card-title">ðŸ“‹ Step Information</div>
                        <div class="info-row"><span class="info-label">Step Code</span><span class="info-value">${step.step_code}</span></div>
                        <div class="info-row"><span class="info-label">Type</span><span class="info-value">${step.step_type}</span></div>
                        <div class="info-row"><span class="info-label">Order</span><span class="info-value">${step.step_order}</span></div>
                        <div class="info-row"><span class="info-label">Status</span><span class="badge badge-${step.status.toLowerCase()}">${step.status}</span></div>
                    </div>
                    <div class="info-card">
                        <div class="info-card-title">â±ï¸ Timing</div>
                        <div class="info-row"><span class="info-label">Started</span><span class="info-value">${step.started_at ? new Date(step.started_at).toLocaleString() : '-'}</span></div>
                        <div class="info-row"><span class="info-label">Completed</span><span class="info-value">${step.completed_at ? new Date(step.completed_at).toLocaleString() : '-'}</span></div>
                        <div class="info-row"><span class="info-label">Duration</span><span class="info-value">${step.started_at && step.completed_at ? Math.round((new Date(step.completed_at) - new Date(step.started_at))) + 'ms' : '-'}</span></div>
                        ${step.api_response_time_ms ? `<div class="info-row"><span class="info-label">API Response Time</span><span class="info-value">${step.api_response_time_ms}ms</span></div>` : ''}
                    </div>
                </div>
                ${step.action_code ? `
                <div class="info-card" style="margin-top: 16px;">
                    <div class="info-card-title">ðŸ“¡ API Response</div>
                    <div class="info-row"><span class="info-label">Action Code</span><span class="info-value" style="color: ${step.action_code === '000' ? 'var(--accent-green)' : 'var(--accent-red)'}">${step.action_code} ${getActionMeaning(step.action_code)}</span></div>
                    ${step.approval_code ? `<div class="info-row"><span class="info-label">Approval Code</span><span class="info-value">${step.approval_code}</span></div>` : ''}
                    ${step.response_code ? `<div class="info-row"><span class="info-label">Response Code</span><span class="info-value">${step.response_code}</span></div>` : ''}
                    ${step.response_message ? `<div class="info-row"><span class="info-label">Response Message</span><span class="info-value">${step.response_message}</span></div>` : ''}
                    ${step.api_status_code ? `<div class="info-row"><span class="info-label">HTTP Status</span><span class="info-value">${step.api_status_code}</span></div>` : ''}
                </div>
                ` : ''}
                ${step.error_message ? `
                <div class="info-card" style="margin-top: 16px; border-color: var(--accent-red);">
                    <div class="info-card-title" style="color: var(--accent-red);">âŒ Error</div>
                    <p style="color: var(--accent-red);">${step.error_message}</p>
                    ${step.error_details ? `<pre class="debug-json" style="margin-top:8px">${formatJson(step.error_details)}</pre>` : ''}
                </div>
                ` : ''}

                <div class="tabs" style="margin-top:24px;">
                    <div class="tab active" onclick="switchStepTab(this, 'input')">Input</div>
                    <div class="tab" onclick="switchStepTab(this, 'output')">Output</div>
                    <div class="tab" onclick="switchStepTab(this, 'transformed')">Transformed</div>
                    <div class="tab" onclick="switchStepTab(this, 'api-req')">ðŸ“¤ API Request</div>
                    <div class="tab" onclick="switchStepTab(this, 'api-res')">ðŸ“¥ API Response</div>
                    <div class="tab" onclick="switchStepTab(this, 'callback')">ðŸ“ž Callback</div>
                </div>
                <div id="step-tab-input" class="step-tab-content">
                    <div style="margin-bottom:8px;color:var(--text-secondary);font-size:12px;">Data received by this step</div>
                    <pre class="debug-json">${formatJson(step.input_payload) || '<i style="color:#888">No data</i>'}</pre>
                </div>
                <div id="step-tab-output" class="step-tab-content" style="display:none">
                    <div style="margin-bottom:8px;color:var(--text-secondary);font-size:12px;">Data output by this step</div>
                    <pre class="debug-json">${formatJson(step.output_payload) || '<i style="color:#888">No data</i>'}</pre>
                </div>
                <div id="step-tab-transformed" class="step-tab-content" style="display:none">
                    <div style="margin-bottom:8px;color:var(--text-secondary);font-size:12px;">Data after field mappings/transformations</div>
                    <pre class="debug-json">${formatJson(step.transformed_payload) || '<i style="color:#888">No data - only captured for TRANSFORM and API_CALL steps</i>'}</pre>
                </div>
                <div id="step-tab-api-req" class="step-tab-content" style="display:none">
                    <div style="margin-bottom:8px;color:var(--text-secondary);font-size:12px;">Request sent to external API (GIP, etc.)</div>
                    <pre class="debug-json">${formatJson(step.api_request) || '<i style="color:#888">No data - only captured for API_CALL steps</i>'}</pre>
                </div>
                <div id="step-tab-api-res" class="step-tab-content" style="display:none">
                    <div style="margin-bottom:8px;color:var(--text-secondary);font-size:12px;">Response from external API</div>
                    <pre class="debug-json">${formatJson(step.api_response) || '<i style="color:#888">No data</i>'}</pre>
                </div>
                <div id="step-tab-callback" class="step-tab-content" style="display:none">
                    <div style="margin-bottom:8px;color:var(--text-secondary);font-size:12px;">Callback data received</div>
                    <pre class="debug-json">${formatJson(step.callback_payload) || '<i style="color:#888">No callback received for this step</i>'}</pre>
                </div>

                <div style="margin-top: 24px; padding-top:16px; border-top: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 12px;">What This Step Does:</h4>
                    <p style="color: var(--text-secondary);">${getStepDescription(step)}</p>
                </div>
            `;
            document.getElementById('stepModal').classList.add('active');
        }

        function switchStepTab(el, id) {
            el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.step-tab-content').forEach(t => t.style.display = 'none');
            document.getElementById(`step-tab-${id}`).style.display = 'block';
        }

        function formatJson(data) {
            if (!data) return null;
            try {
                const obj = typeof data === 'string' ? JSON.parse(data) : data;
                return JSON.stringify(obj, null, 2);
            } catch {
                return data;
            }
        }

        function showStartDetails() {
            document.getElementById('modalTitle').textContent = 'Flow Start';
            document.getElementById('modalBody').innerHTML = `
                <div class="info-card">
                    <div class="info-card-title">â–¶ Flow Initialization</div>
                    <p style="color: var(--text-secondary);">This is the entry point of the flow. The original request payload is received and validated before processing begins.</p>
                    ${currentFlow ? `
                    <div style="margin-top: 16px;">
                        <h4 style="margin-bottom: 8px;">Original Request:</h4>
                        <pre class="debug-json">${JSON.stringify(safeJSON(currentFlow.current_payload), null, 2)}</pre>
                    </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('stepModal').classList.add('active');
        }

        function getStepDescription(step) {
            const descriptions = {
                'START': 'Entry point - receives and validates the incoming request',
                'END': 'Exit point - finalizes the flow and sends response',
                'TRANSFORM': 'Transforms the payload by mapping fields according to the step configuration',
                'API_CALL': 'Makes an external API call (typically to GIP) and processes the response',
                'CONDITION': 'Evaluates the action code to determine the next step in the flow',
                'CALLBACK': 'Waits for an external callback before continuing',
                'LISTENER': 'Registers for an expected callback and waits'
            };
            let desc = descriptions[step.step_type] || 'Executes the configured step logic';

            if (step.step_code.includes('NEC')) desc += '. This step performs a Name Enquiry Check to verify account details.';
            else if (step.step_code.includes('FTD')) desc += '. This step debits the source account (function code 241).';
            else if (step.step_code.includes('FTC')) desc += '. This step credits the destination account (function code 240).';
            else if (step.step_code.includes('CHECK')) desc += '. This evaluates the previous API response to determine success or failure.';
            else if (step.step_code.includes('CALLBACK')) desc += '. This sends the final result back to the calling system (BFS).';

            return desc;
        }

        function getActionMeaning(code) {
            const meanings = { '000': '(Success)', '001': '(Processing)', '381': '(Account not found)', '909': '(Timeout)', '912': '(System unavailable)', '999': '(Validation error)' };
            return meanings[code] || '';
        }

        function closeModal() { document.getElementById('stepModal').classList.remove('active'); }

        function getNodeClass(step) {
            switch(step.step_type) {
                case 'TRANSFORM': return 'transform';
                case 'API_CALL': return 'api-call';
                case 'CONDITION': case 'GATEWAY': return 'condition';
                case 'CALLBACK': case 'LISTENER': return 'callback';
                default: return '';
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'COMPLETED': return 'completed';
                case 'RUNNING': case 'IN_PROGRESS': return 'running';
                case 'FAILED': return 'failed';
                case 'WAITING': return 'waiting';
                default: return 'pending';
            }
        }

        function getStepIcon(type) {
            switch(type) {
                case 'TRANSFORM': return 'âš™';
                case 'API_CALL': return 'â†—';
                case 'CONDITION': case 'GATEWAY': return 'âœ•';
                case 'CALLBACK': case 'LISTENER': return 'âœ‰';
                case 'END': return 'â—‰';
                default: return 'â–¢';
            }
        }

        function getStepTypeLabel(type) {
            switch(type) {
                case 'TRANSFORM': return 'Transform';
                case 'API_CALL': return 'Service';
                case 'CONDITION': case 'GATEWAY': return 'Gateway';
                case 'CALLBACK': case 'LISTENER': return 'Catch';
                default: return type;
            }
        }

        function buildInfoCards(flow, callbacks) {
            const pending = callbacks.filter(c => c.status === 'PENDING').length;
            const timeout = callbacks.filter(c => c.status === 'TIMEOUT').length;
            return `
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-card-title">ðŸ“‹ Flow Details</div>
                        <div class="info-row"><span class="info-label">Instance ID</span><span class="info-value">${flow.id.substring(0,8)}...</span></div>
                        <div class="info-row"><span class="info-label">Session ID</span><span class="info-value">${flow.session_id}</span></div>
                        <div class="info-row"><span class="info-label">Tracking #</span><span class="info-value">${flow.tracking_number || '-'}</span></div>
                        <div class="info-row"><span class="info-label">Flow Type</span><span class="info-value">${flow.flow_code || '-'}</span></div>
                    </div>
                    <div class="info-card">
                        <div class="info-card-title">ðŸ“Š Status</div>
                        <div class="info-row"><span class="info-label">Status</span><span class="badge badge-${flow.status.toLowerCase().replace('_','-')}">${flow.status}</span></div>
                        <div class="info-row"><span class="info-label">Current Step</span><span class="info-value">${flow.current_step || 'N/A'}</span></div>
                        <div class="info-row"><span class="info-label">Callback Sent</span><span class="info-value">${flow.callback_sent ? 'âœ“' : 'âœ—'}</span></div>
                    </div>
                    <div class="info-card">
                        <div class="info-card-title">ðŸ“¨ Callbacks</div>
                        <div class="info-row"><span class="info-label">Total</span><span class="info-value">${callbacks.length}</span></div>
                        <div class="info-row"><span class="info-label">Pending</span><span class="info-value" style="color:${pending > 0 ? 'var(--accent-yellow)' : ''}">${pending}</span></div>
                        <div class="info-row"><span class="info-label">Timed Out</span><span class="info-value" style="color:${timeout > 0 ? 'var(--accent-red)' : ''}">${timeout}</span></div>
                    </div>
                    ${flow.last_error ? `<div class="info-card" style="border-color:var(--accent-red)"><div class="info-card-title" style="color:var(--accent-red)">âŒ Error</div><p style="color:var(--accent-red)">${flow.last_error}</p></div>` : ''}
                </div>
            `;
        }

        function buildDebugPanel(steps) {
            if (!steps.length) return '<div class="empty-state">No steps executed</div>';
            return `<div class="debug-panel"><div class="debug-header">Verbose Execution Log (click to expand)</div><div class="debug-content">${
                steps.map((s, i) => `
                    <div class="debug-entry" onclick="this.classList.toggle('expanded')">
                        <div class="debug-entry-header">
                            <div class="debug-num">${i+1}</div>
                            <span class="debug-name">${s.step_code}</span>
                            <span class="debug-type">${s.step_type}</span>
                            <span class="badge badge-${s.status.toLowerCase()}">${s.status}</span>
                        </div>
                        <div style="font-size:12px;color:var(--text-muted);margin-left:40px;margin-top:4px;">
                            ${s.action_code ? `Action: <strong>${s.action_code}</strong> ${getActionMeaning(s.action_code)}` : ''}
                            ${s.error_message ? `<span style="color:var(--accent-red)"> | Error: ${s.error_message}</span>` : ''}
                        </div>
                        <div class="debug-details">
                            <div class="debug-section"><div class="debug-section-title">Timing</div>Started: ${s.started_at ? new Date(s.started_at).toLocaleString() : '-'}<br>Completed: ${s.completed_at ? new Date(s.completed_at).toLocaleString() : '-'}</div>
                            ${s.action_code ? `<div class="debug-section"><div class="debug-section-title">Response</div>Action: ${s.action_code} ${getActionMeaning(s.action_code)}<br>Approval: ${s.approval_code || '-'}</div>` : ''}
                            ${s.error_message ? `<div class="debug-section"><div class="debug-section-title" style="color:var(--accent-red)">Error</div><p style="color:var(--accent-red)">${s.error_message}</p></div>` : ''}
                        </div>
                    </div>
                `).join('')
            }</div></div>`;
        }

        function buildTimeline(callbacks) {
            if (!callbacks.length) return '<div class="empty-state">No callbacks</div>';
            return `<div class="timeline">${callbacks.map(cb => `
                <div class="timeline-item ${cb.status === 'MATCHED' ? 'success' : cb.status === 'TIMEOUT' ? 'error' : cb.status === 'PENDING' ? 'warning' : ''}">
                    <div class="timeline-time">${new Date(cb.created_at).toLocaleString()}</div>
                    <div class="timeline-content">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <strong>${cb.step_code || 'Unknown'}</strong>
                            <span class="badge badge-${cb.status.toLowerCase()}">${cb.status}</span>
                        </div>
                        <div style="font-size:12px;color:var(--text-muted);">
                            Type: ${cb.callback_type || '-'}<br>
                            Expected: ${cb.expected_by ? new Date(cb.expected_by).toLocaleString() : '-'}<br>
                            ${cb.received_at ? `Received: ${new Date(cb.received_at).toLocaleString()}` : ''}
                        </div>
                        ${cb.status === 'TIMEOUT' ? `<button class="btn btn-success" style="margin-top:12px" onclick="resetCallback('${cb.id}')">Reset Callback</button>` : ''}
                    </div>
                </div>
            `).join('')}</div>`;
        }

        function switchTab(el, id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('[id^="tab-"]').forEach(t => t.style.display = 'none');
            document.getElementById(`tab-${id}`).style.display = 'block';
        }

        // Dashboard
        async function loadDashboard() {
            setTitle('Dashboard');
            setActions('<button class="btn" onclick="loadDashboard()">Refresh</button>');
            setLoading();
            try {
                const stats = await (await fetch(`${API}/stats`)).json();
                if (!stats.success) throw new Error(stats.error);
                const { flows, callbacks, jobs, problems, stuck } = stats.data;
                const total = flows.reduce((s, f) => s + parseInt(f.count), 0);
                const completed = flows.find(f => f.status === 'COMPLETED')?.count || 0;
                const failed = flows.find(f => f.status === 'FAILED')?.count || 0;
                const waiting = flows.find(f => f.status === 'WAITING_CALLBACK')?.count || 0;
                const timeout = callbacks.find(c => c.status === 'TIMEOUT')?.count || 0;

                setContent(`
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value">${total}</div><div class="stat-label">Total Flows (24h)</div></div>
                        <div class="stat-card success"><div class="stat-value">${completed}</div><div class="stat-label">Completed</div></div>
                        <div class="stat-card ${failed > 0 ? 'error' : ''}"><div class="stat-value">${failed}</div><div class="stat-label">Failed</div></div>
                        <div class="stat-card ${waiting > 0 ? 'warning' : ''}"><div class="stat-value">${waiting}</div><div class="stat-label">Waiting</div></div>
                        <div class="stat-card ${stuck > 0 ? 'error' : ''}"><div class="stat-value">${stuck}</div><div class="stat-label">Stuck</div></div>
                        <div class="stat-card ${timeout > 0 ? 'error' : ''}"><div class="stat-value">${timeout}</div><div class="stat-label">Timed Out</div></div>
                    </div>
                    ${problems + stuck > 0 ? `<div class="info-card" style="border-color:var(--accent-red);margin-bottom:24px"><div class="info-card-title" style="color:var(--accent-red)">âš ï¸ ${problems + stuck} Issues Detected</div><p>Review stuck flows and timed out callbacks.</p><div style="margin-top:16px"><button class="btn btn-danger" onclick="showView('stuck')">View Stuck</button> <button class="btn btn-danger" onclick="showView('timedout')">View Timeouts</button></div></div>` : `<div class="info-card" style="border-color:var(--accent-green)"><div class="info-card-title" style="color:var(--accent-green)">âœ“ System Healthy</div><p>No critical issues detected.</p></div>`}
                    <h3 style="margin:24px 0 16px">Quick Actions</h3>
                    <div class="info-grid">
                        <div class="info-card"><div class="info-card-title">ðŸ” Search</div><p style="font-size:12px;color:var(--text-muted)">Enter a session ID in the search bar to analyze a specific flow.</p></div>
                        <div class="info-card"><div class="info-card-title">ðŸ›‘ Stop Spam</div><p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Mark completed flows as callback_sent.</p><button class="btn btn-danger" onclick="stopSpam()">Stop Spam</button></div>
                    </div>
                `);
            } catch (err) {
                setContent(`<div class="empty-state"><div class="empty-icon">âŒ</div><h3>Error</h3><p>${err.message}</p></div>`);
            }
        }

        async function loadRecentFlows() { await loadFlowTable('recent', 'Recent Flows', `${API}/flows/recent?limit=20`); }
        async function loadStuckFlows() { await loadFlowTable('stuck', 'Stuck Flows', `${API}/flows/stuck`, true); }
        async function loadFailedFlows() {
            setTitle('Failed Flows');
            setActions('<button class="btn" onclick="loadFailedFlows()">Refresh</button>');
            setLoading();
            try {
                const data = await (await fetch(`${API}/flows/recent?limit=50`)).json();
                const failed = data.data.filter(f => f.status === 'FAILED');
                if (!failed.length) { setContent('<div class="empty-state"><div class="empty-icon">âœ“</div><h3>No Failed Flows</h3></div>'); return; }
                setContent(buildFlowTable(failed));
            } catch (err) { setContent(`<div class="empty-state">Error: ${err.message}</div>`); }
        }

        async function loadFlowTable(view, title, url, showAge = false) {
            setTitle(title);
            setActions(`<button class="btn" onclick="loadFlowTable('${view}','${title}','${url}',${showAge})">Refresh</button>`);
            setLoading();
            try {
                const data = await (await fetch(url)).json();
                if (!data.data.length) { setContent(`<div class="empty-state"><div class="empty-icon">âœ“</div><h3>No ${title}</h3></div>`); return; }
                setContent(buildFlowTable(data.data, showAge));
            } catch (err) { setContent(`<div class="empty-state">Error: ${err.message}</div>`); }
        }

        function buildFlowTable(flows, showAge = false) {
            return `<table class="data-table"><tr><th>Session ID</th><th>Status</th><th>Step</th><th>Flow</th><th>${showAge ? 'Age' : 'Created'}</th><th>Actions</th></tr>${
                flows.map(f => `<tr>
                    <td><span class="clickable" onclick="analyzeFlow('${f.session_id}')">${f.session_id}</span></td>
                    <td><span class="badge badge-${f.status.toLowerCase().replace('_','-')}">${f.status}</span></td>
                    <td>${f.current_step || '-'}</td>
                    <td>${f.flow_code || '-'}</td>
                    <td>${showAge ? Math.round(f.minutes_old) + ' min' : new Date(f.created_at).toLocaleString()}</td>
                    <td><button class="btn" onclick="analyzeFlow('${f.session_id}')">Analyze</button>${['WAITING_CALLBACK','PENDING'].includes(f.status) ? `<button class="btn btn-success" onclick="resumeFlow('${f.id}')">Resume</button>` : ''}</td>
                </tr>`).join('')
            }</table>`;
        }

        async function loadTimedOutCallbacks() {
            setTitle('Timed Out Callbacks');
            setActions('<button class="btn" onclick="loadTimedOutCallbacks()">Refresh</button>');
            setLoading();
            try {
                const data = await (await fetch(`${API}/callbacks/timedout`)).json();
                if (!data.data.length) { setContent('<div class="empty-state"><div class="empty-icon">âœ“</div><h3>No Timeouts</h3></div>'); return; }
                setContent(`<table class="data-table"><tr><th>ID</th><th>Session</th><th>Step</th><th>Expected</th><th>Flow Status</th><th>Actions</th></tr>${
                    data.data.map(cb => `<tr>
                        <td>${cb.id.substring(0,8)}...</td>
                        <td><span class="clickable" onclick="analyzeFlow('${cb.session_id}')">${cb.session_id}</span></td>
                        <td>${cb.step_code || '-'}</td>
                        <td>${new Date(cb.expected_by).toLocaleString()}</td>
                        <td><span class="badge badge-${cb.flow_status.toLowerCase().replace('_','-')}">${cb.flow_status}</span></td>
                        <td><button class="btn btn-success" onclick="resetCallback('${cb.id}')">Reset</button></td>
                    </tr>`).join('')
                }</table>`);
            } catch (err) { setContent(`<div class="empty-state">Error: ${err.message}</div>`); }
        }

        async function loadCallbackSpam() {
            setTitle('Callback Spam');
            setActions('<button class="btn" onclick="loadCallbackSpam()">Refresh</button><button class="btn btn-danger" onclick="stopSpam()">Stop All</button>');
            setLoading();
            try {
                const data = await (await fetch(`${API}/flows/callback-spam`)).json();
                if (!data.data.length) { setContent('<div class="empty-state"><div class="empty-icon">âœ“</div><h3>No Spam</h3></div>'); return; }
                setContent(`<div class="info-card" style="border-color:var(--accent-yellow);margin-bottom:24px"><div class="info-card-title" style="color:var(--accent-yellow)">âš ï¸ ${data.data.length} flows causing spam</div></div>
                <table class="data-table"><tr><th>Session ID</th><th>Status</th><th>Error Count</th><th>Callback URL</th></tr>${
                    data.data.map(f => `<tr><td>${f.session_id}</td><td><span class="badge badge-${f.status.toLowerCase()}">${f.status}</span></td><td>${f.error_count || 0}</td><td style="max-width:300px;overflow:hidden;text-overflow:ellipsis">${f.bfs_callback_url || '-'}</td></tr>`).join('')
                }</table>`);
            } catch (err) { setContent(`<div class="empty-state">Error: ${err.message}</div>`); }
        }

        async function loadJobQueue() {
            setTitle('Job Queue');
            setActions('<button class="btn" onclick="loadJobQueue()">Refresh</button>');
            setLoading();
            try {
                const data = await (await fetch(`${API}/jobs/pending`)).json();
                if (!data.success) { setContent(`<div class="empty-state"><div class="empty-icon">âŒ</div><h3>Error</h3><p>${data.error}</p></div>`); return; }
                if (!data.data.length) { setContent('<div class="empty-state"><div class="empty-icon">âœ“</div><h3>Queue Empty</h3><p>No pending, processing, or failed jobs</p></div>'); return; }
                setContent(`<table class="data-table"><tr><th>ID</th><th>Type</th><th>Name</th><th>Status</th><th>Priority</th><th>Attempts</th><th>Scheduled</th><th>Error</th><th>Actions</th></tr>${
                    data.data.map(j => `<tr>
                        <td>${j.id.substring(0,8)}...</td>
                        <td>${j.job_type}</td>
                        <td>${j.job_name || '-'}</td>
                        <td><span class="badge badge-${j.status.toLowerCase()}">${j.status}</span></td>
                        <td>${j.priority || 0}</td>
                        <td>${j.attempt_number || 0}/${j.max_attempts || 3}</td>
                        <td>${j.scheduled_for ? new Date(j.scheduled_for).toLocaleString() : '-'}</td>
                        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis" title="${j.error_message || ''}">${j.error_message ? j.error_message.substring(0,50) + '...' : '-'}</td>
                        <td>${j.status === 'FAILED' ? `<button class="btn btn-success" onclick="retryJob('${j.id}')">Retry</button>` : ''}</td>
                    </tr>`).join('')
                }</table>`);
            } catch (err) { setContent(`<div class="empty-state"><div class="empty-icon">âŒ</div><h3>Error</h3><p>${err.message}</p></div>`); }
        }

        // Flow Setup
        let allFlows = [];
        let selectedFlow = null;

        async function showFlowSetup() {
            setTitle('Flow Setup');
            setActions('<button class="btn btn-primary" onclick="showCreateFlowModal()">+ New Flow</button>');
            setLoading();
            try {
                const flows = await (await fetch(`${API}/flows/definitions`)).json();
                allFlows = flows.success ? flows.data : [];

                setContent(`
                    <div class="flow-setup-grid">
                        <div class="flow-list">
                            <div class="flow-list-header">Flows (${allFlows.length})</div>
                            <div class="flow-list-items" id="flowListItems">
                                ${allFlows.length ? allFlows.map(f => `
                                    <div class="flow-list-item" data-flow-id="${f.id}" onclick="loadFlowConfig('${f.id}', '${f.flow_code}')">
                                        <div style="display:flex;justify-content:space-between;align-items:center;">
                                            <h4>${f.flow_name || f.flow_code}</h4>
                                            <span class="badge ${f.is_active ? 'badge-success' : 'badge-pending'}" style="font-size:9px">${f.is_active ? 'Active' : 'Inactive'}</span>
                                        </div>
                                        <p>${f.description || 'No description'}</p>
                                        <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Code: ${f.flow_code} | ${f.is_sync ? 'Sync' : 'Async'}</div>
                                    </div>
                                `).join('') : '<div style="padding:16px;color:var(--text-muted)">No flows configured. Click "+ New Flow" to create one.</div>'}
                            </div>
                        </div>
                        <div class="flow-editor">
                            <div class="flow-editor-header" id="flowEditorHeader">
                                <span>Select a flow to view its configuration</span>
                            </div>
                            <div class="flow-editor-canvas" id="flowEditorCanvas">
                                <div class="empty-state">
                                    <div class="empty-icon">ðŸ“‹</div>
                                    <h3>Select a Flow</h3>
                                    <p>Choose a flow from the list to view and edit its steps.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            } catch (err) {
                setContent(`<div class="empty-state"><div class="empty-icon">âŒ</div><h3>Error</h3><p>${err.message}</p></div>`);
            }
        }

        async function loadFlowConfig(flowId, flowCode) {
            selectedFlow = allFlows.find(f => f.id === flowId);

            // Highlight selected flow
            document.querySelectorAll('.flow-list-item').forEach(item => {
                item.classList.toggle('active', item.dataset.flowId === flowId);
            });

            try {
                const steps = await (await fetch(`${API}/steps/${flowCode}`)).json();
                const header = document.getElementById('flowEditorHeader');
                const canvas = document.getElementById('flowEditorCanvas');

                header.innerHTML = `
                    <div>
                        <strong>${selectedFlow?.flow_name || flowCode}</strong>
                        <span style="color:var(--text-muted);font-size:12px;margin-left:8px">${flowCode}</span>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn" onclick="showEditFlowModal('${flowId}')">Edit Flow</button>
                        <button class="btn btn-primary" onclick="showCreateStepModal('${flowId}')">+ Add Step</button>
                        <button class="btn btn-danger" onclick="deleteFlow('${flowId}')">Delete</button>
                    </div>
                `;

                if (!steps.success || !steps.data.length) {
                    canvas.innerHTML = '<div class="empty-state"><div class="empty-icon">ðŸ“</div><h3>No Steps</h3><p>This flow has no steps. Click "+ Add Step" to create one.</p></div>';
                    return;
                }
                canvas.innerHTML = `
                    ${steps.data.map((s, i) => `
                        <div class="flow-step-card" data-step-id="${s.id || i}">
                            <div class="flow-step-num" style="background:${getStepColor(s.step_type)}">${i + 1}</div>
                            <div class="flow-step-info" style="flex:1">
                                <div class="flow-step-name">${s.step_code}</div>
                                <div class="flow-step-type">${s.step_type} | Order: ${s.step_order}</div>
                            </div>
                            <button class="btn" onclick="showEditStepModal('${flowId}', ${JSON.stringify(s).replace(/"/g, '&quot;')})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteStep('${s.id}', '${flowId}', '${flowCode}')">Ã—</button>
                        </div>
                    `).join('')}
                `;
            } catch (err) {
                document.getElementById('flowEditorCanvas').innerHTML = `<div class="empty-state"><div class="empty-icon">âŒ</div><p>${err.message}</p></div>`;
            }
        }

        function getStepColor(type) {
            const colors = { 'TRANSFORM': 'var(--accent-purple)', 'API_CALL': 'var(--accent-blue)', 'CONDITION': 'var(--accent-yellow)', 'CALLBACK': 'var(--accent-cyan)', 'LISTENER': 'var(--accent-cyan)' };
            return colors[type] || 'var(--accent-blue)';
        }

        function showCreateFlowModal() {
            document.getElementById('modalTitle').textContent = 'Create New Flow';
            document.getElementById('modalBody').innerHTML = `
                <form id="flowForm" onsubmit="saveFlow(event)">
                    <div class="info-card">
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Flow Code *</label>
                            <input type="text" name="flow_code" class="search-input" style="width:100%;max-width:100%" required placeholder="e.g., FT_TRANSFER">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Flow Name</label>
                            <input type="text" name="flow_name" class="search-input" style="width:100%;max-width:100%" placeholder="e.g., Funds Transfer">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Description</label>
                            <textarea name="description" class="search-input" style="width:100%;max-width:100%;min-height:80px" placeholder="Describe what this flow does"></textarea>
                        </div>
                        <div style="display:flex;gap:24px;margin-bottom:16px">
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" name="is_sync"> Synchronous
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" name="is_active" checked> Active
                            </label>
                        </div>
                    </div>
                    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px">
                        <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Flow</button>
                    </div>
                </form>
            `;
            document.getElementById('stepModal').classList.add('active');
        }

        function showEditFlowModal(flowId) {
            const flow = allFlows.find(f => f.id === flowId);
            if (!flow) return;

            document.getElementById('modalTitle').textContent = 'Edit Flow';
            document.getElementById('modalBody').innerHTML = `
                <form id="flowForm" onsubmit="updateFlow(event, '${flowId}')">
                    <div class="info-card">
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Flow Code *</label>
                            <input type="text" name="flow_code" class="search-input" style="width:100%;max-width:100%" required value="${flow.flow_code}">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Flow Name</label>
                            <input type="text" name="flow_name" class="search-input" style="width:100%;max-width:100%" value="${flow.flow_name || ''}">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Description</label>
                            <textarea name="description" class="search-input" style="width:100%;max-width:100%;min-height:80px">${flow.description || ''}</textarea>
                        </div>
                        <div style="display:flex;gap:24px;margin-bottom:16px">
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" name="is_sync" ${flow.is_sync ? 'checked' : ''}> Synchronous
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" name="is_active" ${flow.is_active ? 'checked' : ''}> Active
                            </label>
                        </div>
                    </div>
                    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px">
                        <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;
            document.getElementById('stepModal').classList.add('active');
        }

        async function saveFlow(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                flow_code: form.flow_code.value,
                flow_name: form.flow_name.value,
                description: form.description.value,
                is_sync: form.is_sync.checked,
                is_active: form.is_active.checked
            };

            try {
                const res = await fetch(`${API}/flows`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal();
                    showFlowSetup();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function updateFlow(e, flowId) {
            e.preventDefault();
            const form = e.target;
            const data = {
                flow_code: form.flow_code.value,
                flow_name: form.flow_name.value,
                description: form.description.value,
                is_sync: form.is_sync.checked,
                is_active: form.is_active.checked
            };

            try {
                const res = await fetch(`${API}/flows/${flowId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal();
                    showFlowSetup();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteFlow(flowId) {
            if (!confirm('Delete this flow and all its steps? This cannot be undone.')) return;
            try {
                const res = await fetch(`${API}/flows/${flowId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    showFlowSetup();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function showCreateStepModal(flowId) {
            document.getElementById('modalTitle').textContent = 'Add New Step';
            document.getElementById('modalBody').innerHTML = `
                <form id="stepForm" onsubmit="saveStep(event, '${flowId}')">
                    <div class="info-card">
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Step Code *</label>
                            <input type="text" name="step_code" class="search-input" style="width:100%;max-width:100%" required placeholder="e.g., FT_TRANSFORM">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Step Type *</label>
                            <select name="step_type" class="search-input" style="width:100%;max-width:100%" required onchange="updateStepTypeHints(this.value)">
                                <option value="">Select type...</option>
                                <option value="TRANSFORM">TRANSFORM - Map and transform fields</option>
                                <option value="API_CALL">API_CALL - Call external API</option>
                                <option value="CONDITION">CONDITION - Evaluate response codes</option>
                                <option value="CALLBACK">CALLBACK - Send callback</option>
                                <option value="LISTENER">LISTENER - Wait for callback</option>
                            </select>
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Step Order</label>
                            <input type="number" name="step_order" class="search-input" style="width:100px" value="0">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Input Mapping</label>
                            <div class="editor-toggle">
                                <button type="button" class="editor-toggle-btn active" onclick="toggleMappingEditor('visual')">Visual Editor</button>
                                <button type="button" class="editor-toggle-btn" onclick="toggleMappingEditor('json')">JSON</button>
                            </div>
                            <div id="mappingVisualEditor">
                                <div class="mapping-list" id="mappingList"></div>
                                <div class="add-mapping-btn" onclick="addMappingRow()">+ Add Field Mapping</div>
                            </div>
                            <div id="mappingJsonEditor" style="display:none">
                                <textarea name="input_mapping" class="search-input" style="width:100%;max-width:100%;min-height:100px;font-family:monospace" placeholder='[{"source": "field1", "target": "field2"}]'></textarea>
                            </div>
                        </div>
                        <div style="margin-bottom:16px" id="configSection">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Configuration</label>
                            <div class="editor-toggle">
                                <button type="button" class="editor-toggle-btn active" onclick="toggleConfigEditor('visual')">Visual Editor</button>
                                <button type="button" class="editor-toggle-btn" onclick="toggleConfigEditor('json')">JSON</button>
                            </div>
                            <div id="configVisualEditor">
                                <div id="configFields"></div>
                                <div class="add-mapping-btn" onclick="addConfigField()">+ Add Config Field</div>
                            </div>
                            <div id="configJsonEditor" style="display:none">
                                <textarea name="config" class="search-input" style="width:100%;max-width:100%;min-height:100px;font-family:monospace" placeholder='{"key": "value"}'></textarea>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px">
                        <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Step</button>
                    </div>
                </form>
            `;
            document.getElementById('stepModal').classList.add('active');
        }

        function showEditStepModal(flowId, step) {
            const s = typeof step === 'string' ? JSON.parse(step.replace(/&quot;/g, '"')) : step;
            const mappings = parseMappings(s.input_mapping);
            const configs = parseConfig(s.config);

            document.getElementById('modalTitle').textContent = 'Edit Step: ' + s.step_code;
            document.getElementById('modalBody').innerHTML = `
                <form id="stepForm" onsubmit="updateStep(event, '${s.id}', '${flowId}')">
                    <div class="info-card">
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Step Code *</label>
                            <input type="text" name="step_code" class="search-input" style="width:100%;max-width:100%" required value="${s.step_code}">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Step Type *</label>
                            <select name="step_type" class="search-input" style="width:100%;max-width:100%" required onchange="updateStepTypeHints(this.value)">
                                <option value="TRANSFORM" ${s.step_type === 'TRANSFORM' ? 'selected' : ''}>TRANSFORM - Map and transform fields</option>
                                <option value="API_CALL" ${s.step_type === 'API_CALL' ? 'selected' : ''}>API_CALL - Call external API</option>
                                <option value="CONDITION" ${s.step_type === 'CONDITION' ? 'selected' : ''}>CONDITION - Evaluate response codes</option>
                                <option value="CALLBACK" ${s.step_type === 'CALLBACK' ? 'selected' : ''}>CALLBACK - Send callback</option>
                                <option value="LISTENER" ${s.step_type === 'LISTENER' ? 'selected' : ''}>LISTENER - Wait for callback</option>
                            </select>
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Step Order</label>
                            <input type="number" name="step_order" class="search-input" style="width:100px" value="${s.step_order || 0}">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Input Mapping</label>
                            <div class="editor-toggle">
                                <button type="button" class="editor-toggle-btn active" onclick="toggleMappingEditor('visual')">Visual Editor</button>
                                <button type="button" class="editor-toggle-btn" onclick="toggleMappingEditor('json')">JSON</button>
                            </div>
                            <div id="mappingVisualEditor">
                                <div class="mapping-list" id="mappingList">${mappings.map((m, i) => createMappingRow(m, i)).join('')}</div>
                                <div class="add-mapping-btn" onclick="addMappingRow()">+ Add Field Mapping</div>
                            </div>
                            <div id="mappingJsonEditor" style="display:none">
                                <textarea name="input_mapping" class="search-input" style="width:100%;max-width:100%;min-height:100px;font-family:monospace">${s.input_mapping ? (typeof s.input_mapping === 'string' ? s.input_mapping : JSON.stringify(s.input_mapping, null, 2)) : ''}</textarea>
                            </div>
                        </div>
                        <div style="margin-bottom:16px" id="configSection">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Configuration</label>
                            <div class="editor-toggle">
                                <button type="button" class="editor-toggle-btn active" onclick="toggleConfigEditor('visual')">Visual Editor</button>
                                <button type="button" class="editor-toggle-btn" onclick="toggleConfigEditor('json')">JSON</button>
                            </div>
                            <div id="configVisualEditor">
                                <div id="configFields">${configs.map((c, i) => createConfigField(c, i)).join('')}</div>
                                <div class="add-mapping-btn" onclick="addConfigField()">+ Add Config Field</div>
                            </div>
                            <div id="configJsonEditor" style="display:none">
                                <textarea name="config" class="search-input" style="width:100%;max-width:100%;min-height:100px;font-family:monospace">${s.config ? (typeof s.config === 'string' ? s.config : JSON.stringify(s.config, null, 2)) : ''}</textarea>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px">
                        <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;
            document.getElementById('stepModal').classList.add('active');
        }

        // Mapping/Config Editor Helpers
        let mappingCounter = 0;
        let configCounter = 0;

        function parseMappings(data) {
            if (!data) return [];
            const parsed = typeof data === 'string' ? JSON.parse(data) : data;
            return Array.isArray(parsed) ? parsed : [];
        }

        function parseConfig(data) {
            if (!data) return [];
            const parsed = typeof data === 'string' ? JSON.parse(data) : data;
            return Object.entries(parsed).map(([key, value]) => ({ key, value }));
        }

        function createMappingRow(mapping = {}, idx) {
            return `
                <div class="mapping-item" data-idx="${idx}">
                    <input type="text" class="mapping-source" placeholder="Source field" value="${mapping.source || ''}" title="Field from input payload">
                    <span class="mapping-arrow">â†’</span>
                    <input type="text" class="mapping-target" placeholder="Target field" value="${mapping.target || ''}" title="Field in output payload">
                    <select class="mapping-transform" title="Transform function">
                        <option value="">No transform</option>
                        <option value="formatAmount" ${mapping.transform === 'formatAmount' ? 'selected' : ''}>formatAmount</option>
                        <option value="formatDate" ${mapping.transform === 'formatDate' ? 'selected' : ''}>formatDate</option>
                        <option value="uppercase" ${mapping.transform === 'uppercase' ? 'selected' : ''}>uppercase</option>
                        <option value="lowercase" ${mapping.transform === 'lowercase' ? 'selected' : ''}>lowercase</option>
                    </select>
                    <button type="button" class="mapping-remove" onclick="removeMappingRow(this)">Ã—</button>
                </div>
            `;
        }

        function createConfigField(config = {}, idx) {
            return `
                <div class="config-field" data-idx="${idx}">
                    <input type="text" class="config-key" placeholder="Key" value="${config.key || ''}">
                    <input type="text" class="config-value" placeholder="Value" value="${config.value || ''}">
                    <button type="button" class="mapping-remove" onclick="removeConfigField(this)">Ã—</button>
                </div>
            `;
        }

        function addMappingRow() {
            const list = document.getElementById('mappingList');
            list.insertAdjacentHTML('beforeend', createMappingRow({}, mappingCounter++));
        }

        function removeMappingRow(btn) {
            btn.closest('.mapping-item').remove();
        }

        function addConfigField() {
            const container = document.getElementById('configFields');
            container.insertAdjacentHTML('beforeend', createConfigField({}, configCounter++));
        }

        function removeConfigField(btn) {
            btn.closest('.config-field').remove();
        }

        function toggleMappingEditor(mode) {
            const visual = document.getElementById('mappingVisualEditor');
            const json = document.getElementById('mappingJsonEditor');
            const btns = visual.previousElementSibling.querySelectorAll('.editor-toggle-btn');

            if (mode === 'visual') {
                visual.style.display = 'block';
                json.style.display = 'none';
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
                // Convert JSON to visual
                try {
                    const textarea = json.querySelector('textarea');
                    if (textarea.value) {
                        const mappings = JSON.parse(textarea.value);
                        document.getElementById('mappingList').innerHTML = mappings.map((m, i) => createMappingRow(m, i)).join('');
                    }
                } catch {}
            } else {
                visual.style.display = 'none';
                json.style.display = 'block';
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
                // Convert visual to JSON
                const mappings = collectMappings();
                json.querySelector('textarea').value = mappings.length ? JSON.stringify(mappings, null, 2) : '';
            }
        }

        function toggleConfigEditor(mode) {
            const visual = document.getElementById('configVisualEditor');
            const json = document.getElementById('configJsonEditor');
            const btns = visual.previousElementSibling.querySelectorAll('.editor-toggle-btn');

            if (mode === 'visual') {
                visual.style.display = 'block';
                json.style.display = 'none';
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
                // Convert JSON to visual
                try {
                    const textarea = json.querySelector('textarea');
                    if (textarea.value) {
                        const config = JSON.parse(textarea.value);
                        const fields = Object.entries(config).map(([key, value]) => ({ key, value }));
                        document.getElementById('configFields').innerHTML = fields.map((c, i) => createConfigField(c, i)).join('');
                    }
                } catch {}
            } else {
                visual.style.display = 'none';
                json.style.display = 'block';
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
                // Convert visual to JSON
                const config = collectConfig();
                json.querySelector('textarea').value = Object.keys(config).length ? JSON.stringify(config, null, 2) : '';
            }
        }

        function collectMappings() {
            const items = document.querySelectorAll('#mappingList .mapping-item');
            const mappings = [];
            items.forEach(item => {
                const source = item.querySelector('.mapping-source').value.trim();
                const target = item.querySelector('.mapping-target').value.trim();
                const transform = item.querySelector('.mapping-transform').value;
                if (source && target) {
                    const m = { source, target };
                    if (transform) m.transform = transform;
                    mappings.push(m);
                }
            });
            return mappings;
        }

        function collectConfig() {
            const items = document.querySelectorAll('#configFields .config-field');
            const config = {};
            items.forEach(item => {
                const key = item.querySelector('.config-key').value.trim();
                const value = item.querySelector('.config-value').value.trim();
                if (key) config[key] = value;
            });
            return config;
        }

        function updateStepTypeHints(type) {
            // Could add contextual hints based on step type
        }

        async function saveStep(e, flowId) {
            e.preventDefault();
            const form = e.target;

            // Collect from visual or JSON editor
            let config = null, input_mapping = null;
            const mappingVisual = document.getElementById('mappingVisualEditor');
            const configVisual = document.getElementById('configVisualEditor');

            if (mappingVisual.style.display !== 'none') {
                input_mapping = collectMappings();
                if (input_mapping.length === 0) input_mapping = null;
            } else {
                try { if (form.input_mapping.value) input_mapping = JSON.parse(form.input_mapping.value); }
                catch { alert('Invalid Input Mapping JSON'); return; }
            }

            if (configVisual.style.display !== 'none') {
                config = collectConfig();
                if (Object.keys(config).length === 0) config = null;
            } else {
                try { if (form.config.value) config = JSON.parse(form.config.value); }
                catch { alert('Invalid Config JSON'); return; }
            }

            const data = {
                flow_id: flowId,
                step_code: form.step_code.value,
                step_type: form.step_type.value,
                step_order: parseInt(form.step_order.value) || 0,
                config,
                input_mapping
            };

            try {
                const res = await fetch(`${API}/steps`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal();
                    loadFlowConfig(flowId, selectedFlow.flow_code);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function updateStep(e, stepId, flowId) {
            e.preventDefault();
            const form = e.target;

            // Collect from visual or JSON editor
            let config = null, input_mapping = null;
            const mappingVisual = document.getElementById('mappingVisualEditor');
            const configVisual = document.getElementById('configVisualEditor');

            if (mappingVisual.style.display !== 'none') {
                input_mapping = collectMappings();
                if (input_mapping.length === 0) input_mapping = null;
            } else {
                try { if (form.input_mapping.value) input_mapping = JSON.parse(form.input_mapping.value); }
                catch { alert('Invalid Input Mapping JSON'); return; }
            }

            if (configVisual.style.display !== 'none') {
                config = collectConfig();
                if (Object.keys(config).length === 0) config = null;
            } else {
                try { if (form.config.value) config = JSON.parse(form.config.value); }
                catch { alert('Invalid Config JSON'); return; }
            }

            const data = {
                step_code: form.step_code.value,
                step_type: form.step_type.value,
                step_order: parseInt(form.step_order.value) || 0,
                config,
                input_mapping
            };

            try {
                const res = await fetch(`${API}/steps/${stepId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal();
                    loadFlowConfig(flowId, selectedFlow.flow_code);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteStep(stepId, flowId, flowCode) {
            if (!confirm('Delete this step?')) return;
            try {
                const res = await fetch(`${API}/steps/${stepId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    loadFlowConfig(flowId, flowCode);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        let allEvents = [];

        async function showEventTypes() {
            setTitle('Event Types');
            setActions('<button class="btn btn-primary" onclick="showCreateEventModal()">+ New Event</button>');
            setLoading();
            try {
                const [eventsRes, flowsRes] = await Promise.all([
                    fetch(`${API}/events`),
                    fetch(`${API}/flows/definitions`)
                ]);
                const eventsData = await eventsRes.json();
                const flowsData = await flowsRes.json();
                allEvents = eventsData.success ? eventsData.data : [];
                allFlows = flowsData.success ? flowsData.data : [];

                setContent(`
                    <div class="info-card" style="margin-bottom:24px">
                        <div class="info-card-title">ðŸ“ Event Types</div>
                        <p style="color:var(--text-muted)">Event types map incoming request types to their corresponding flows. When a request arrives, the orchestrator uses the event code to determine which flow to execute.</p>
                    </div>
                    <table class="data-table">
                        <tr><th>Code</th><th>Name</th><th>Description</th><th>Function Code</th><th>Sync</th><th>Status</th><th>Actions</th></tr>
                        ${allEvents.length ? allEvents.map(e => `
                            <tr>
                                <td><strong>${e.code}</strong></td>
                                <td>${e.name || '-'}</td>
                                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis" title="${e.description || ''}">${e.description || '-'}</td>
                                <td>${e.function_code ? `<code style="background:var(--bg-secondary);padding:2px 8px;border-radius:4px">${e.function_code}</code>` : '<span style="color:var(--accent-red)">Not set</span>'}</td>
                                <td>${e.is_sync ? 'âœ“ Sync' : 'Async'}</td>
                                <td>${e.is_active ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-pending">Inactive</span>'}</td>
                                <td>
                                    <button class="btn" onclick="showEditEventModal('${e.id}')">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteEvent('${e.id}')">Ã—</button>
                                </td>
                            </tr>
                        `).join('') : '<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-muted)">No event types configured. Click "+ New Event" to create one.</td></tr>'}
                    </table>
                `);
            } catch (err) {
                setContent(`<div class="empty-state"><div class="empty-icon">âŒ</div><h3>Error</h3><p>${err.message}</p></div>`);
            }
        }

        function showCreateEventModal() {
            document.getElementById('modalTitle').textContent = 'Create Event Type';
            document.getElementById('modalBody').innerHTML = `
                <form id="eventForm" onsubmit="saveEvent(event)">
                    <div class="info-card">
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Event Code *</label>
                            <input type="text" name="code" class="search-input" style="width:100%;max-width:100%" required placeholder="e.g., FT or REV">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Name</label>
                            <input type="text" name="name" class="search-input" style="width:100%;max-width:100%" placeholder="e.g., Funds Transfer">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Description</label>
                            <textarea name="description" class="search-input" style="width:100%;max-width:100%;min-height:80px" placeholder="Describe what this event type handles"></textarea>
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Function Code</label>
                            <input type="text" name="function_code" class="search-input" style="width:100%;max-width:100%" placeholder="e.g., PROCESS_FT or HANDLE_REV">
                            <small style="color:var(--text-muted);margin-top:4px;display:block">The function code that handles this event type</small>
                        </div>
                        <div style="display:flex;gap:24px;margin-bottom:16px">
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" name="is_sync"> Synchronous
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" name="is_active" checked> Active
                            </label>
                        </div>
                    </div>
                    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px">
                        <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Event</button>
                    </div>
                </form>
            `;
            document.getElementById('stepModal').classList.add('active');
        }

        function showEditEventModal(eventId) {
            const evt = allEvents.find(e => e.id === eventId);
            if (!evt) return;

            document.getElementById('modalTitle').textContent = 'Edit Event Type';
            document.getElementById('modalBody').innerHTML = `
                <form id="eventForm" onsubmit="updateEvent(event, '${eventId}')">
                    <div class="info-card">
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Event Code *</label>
                            <input type="text" name="code" class="search-input" style="width:100%;max-width:100%" required value="${evt.code}">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Name</label>
                            <input type="text" name="name" class="search-input" style="width:100%;max-width:100%" value="${evt.name || ''}">
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Description</label>
                            <textarea name="description" class="search-input" style="width:100%;max-width:100%;min-height:80px">${evt.description || ''}</textarea>
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block;margin-bottom:6px;color:var(--text-secondary)">Function Code</label>
                            <input type="text" name="function_code" class="search-input" style="width:100%;max-width:100%" value="${evt.function_code || ''}" placeholder="e.g., PROCESS_FT or HANDLE_REV">
                            <small style="color:var(--text-muted);margin-top:4px;display:block">The function code that handles this event type</small>
                        </div>
                        <div style="display:flex;gap:24px;margin-bottom:16px">
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" name="is_sync" ${evt.is_sync ? 'checked' : ''}> Synchronous
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" name="is_active" ${evt.is_active ? 'checked' : ''}> Active
                            </label>
                        </div>
                    </div>
                    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px">
                        <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;
            document.getElementById('stepModal').classList.add('active');
        }

        async function saveEvent(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                code: form.code.value,
                name: form.name.value,
                description: form.description.value,
                function_code: form.function_code.value || null,
                is_sync: form.is_sync.checked,
                is_active: form.is_active.checked
            };

            try {
                const res = await fetch(`${API}/events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal();
                    showEventTypes();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function updateEvent(e, eventId) {
            e.preventDefault();
            const form = e.target;
            const data = {
                code: form.code.value,
                name: form.name.value,
                description: form.description.value,
                function_code: form.function_code.value || null,
                is_sync: form.is_sync.checked,
                is_active: form.is_active.checked
            };

            try {
                const res = await fetch(`${API}/events/${eventId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal();
                    showEventTypes();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Delete this event type?')) return;
            try {
                const res = await fetch(`${API}/events/${eventId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    showEventTypes();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function showGuide() {
            setTitle('Troubleshooting Guide');
            setActions('');
            setContent(`
                <div class="info-card" style="margin-bottom:20px">
                    <div class="info-card-title">ðŸ” Flow Stuck in PENDING</div>
                    <ol style="margin-left:20px;line-height:2;color:var(--text-secondary)">
                        <li>Check <span class="clickable" onclick="showView('jobs')">Job Queue</span> for failed jobs</li>
                        <li>If job failed, click <strong>Retry</strong></li>
                        <li>If no job, use <strong>Resume</strong> on the flow</li>
                    </ol>
                </div>
                <div class="info-card" style="margin-bottom:20px">
                    <div class="info-card-title">â° Flow Stuck in WAITING_CALLBACK</div>
                    <ol style="margin-left:20px;line-height:2;color:var(--text-secondary)">
                        <li>Search for the flow using Session ID</li>
                        <li>Check Callbacks tab for TIMEOUT status</li>
                        <li>Click <strong>Reset Callback</strong> to extend timeout</li>
                        <li>Verify GIP is sending callbacks</li>
                    </ol>
                </div>
                <div class="info-card" style="margin-bottom:20px">
                    <div class="info-card-title">ðŸ“¢ BFS Getting Repeated Callbacks</div>
                    <ol style="margin-left:20px;line-height:2;color:var(--text-secondary)">
                        <li>Go to <span class="clickable" onclick="showView('spam')">Callback Spam</span></li>
                        <li>Click <strong>Stop All Spam</strong></li>
                    </ol>
                </div>
                <div class="info-card">
                    <div class="info-card-title">ðŸ“ Column Reference</div>
                    <table class="data-table" style="margin-top:12px">
                        <tr><th>Table</th><th>Wrong</th><th>Correct</th></tr>
                        <tr><td>expected_callbacks</td><td>is_matched</td><td>status</td></tr>
                        <tr><td>received_callbacks</td><td>is_matched</td><td>processed</td></tr>
                        <tr><td>process_logs</td><td>event_type</td><td>log_type</td></tr>
                        <tr><td>job_queue</td><td>job_data</td><td>payload</td></tr>
                        <tr><td>tsq_requests</td><td>session_id</td><td>original_session_id</td></tr>
                    </table>
                </div>
            `);
        }

        // ============================================
        // SYSTEM CONFIGURATION
        // ============================================
        let allConfigs = [];

        async function showSystemConfigs() {
            setTitle('System Configuration');
            setActions('<button class="btn btn-primary" onclick="showCreateConfigModal()">+ Add Config</button>');
            setLoading();

            try {
                const res = await fetch(`${API}/configs`);
                const data = await res.json();
                allConfigs = data.success ? (data.data || []) : [];

                if (allConfigs.length === 0) {
                    setContent(`
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ”§</div>
                            <h3>No Configurations</h3>
                            <p>Add system configurations to manage settings like callback URLs, timeouts, etc.</p>
                            <button class="btn btn-primary" onclick="showCreateConfigModal()">Add First Config</button>
                        </div>
                    `);
                    return;
                }

                let html = `
                    <div class="info-card" style="margin-bottom:20px;padding:16px">
                        <div class="info-card-title" style="margin-bottom:12px">ðŸ“‹ Important Configurations</div>
                        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:8px">
                            These settings control orchestrator behavior. Changes take effect immediately.
                        </p>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>Value</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th style="width:120px">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const cfg of allConfigs) {
                    const isUrl = cfg.config_key.includes('URL');
                    const displayValue = isUrl
                        ? `<a href="${cfg.config_value}" target="_blank" style="color:var(--accent-blue)">${cfg.config_value}</a>`
                        : `<code style="background:var(--bg-primary);padding:2px 6px;border-radius:4px">${cfg.config_value}</code>`;

                    html += `
                        <tr>
                            <td><strong>${cfg.config_key}</strong></td>
                            <td>${displayValue}</td>
                            <td><span class="status-badge" style="background:var(--accent-purple)">${cfg.config_type || 'STRING'}</span></td>
                            <td style="color:var(--text-secondary);font-size:12px">${cfg.description || '-'}</td>
                            <td>
                                <button class="btn" style="padding:4px 8px;font-size:11px" onclick="showEditConfigModal('${cfg.id}')">Edit</button>
                                <button class="btn btn-danger" style="padding:4px 8px;font-size:11px" onclick="deleteConfig('${cfg.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }

                html += '</tbody></table>';
                setContent(html);
            } catch (err) {
                setContent(`<div class="empty-state"><div class="empty-icon">âŒ</div><h3>Error</h3><p>${err.message}</p></div>`);
            }
        }

        function showCreateConfigModal() {
            document.getElementById('modalTitle').textContent = 'Add Configuration';
            document.getElementById('modalBody').innerHTML = `
                <div style="display:flex;flex-direction:column;gap:16px">
                    <div>
                        <label style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px">Config Key *</label>
                        <input type="text" id="configKey" placeholder="e.g. ORCHESTRATOR_BASE_URL" style="width:100%;padding:10px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary)">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px">Config Value *</label>
                        <input type="text" id="configValue" placeholder="e.g. http://localhost:3002" style="width:100%;padding:10px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary)">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px">Type</label>
                        <select id="configType" style="width:100%;padding:10px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary)">
                            <option value="STRING">STRING</option>
                            <option value="NUMBER">NUMBER</option>
                            <option value="BOOLEAN">BOOLEAN</option>
                            <option value="JSON">JSON</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px">Description</label>
                        <input type="text" id="configDesc" placeholder="What this config does..." style="width:100%;padding:10px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary)">
                    </div>
                    <button class="btn btn-primary" onclick="createConfig()">Create Configuration</button>
                </div>
            `;
            document.getElementById('stepModal').style.display = 'flex';
        }

        async function createConfig() {
            const key = document.getElementById('configKey').value.trim();
            const value = document.getElementById('configValue').value.trim();
            const type = document.getElementById('configType').value;
            const desc = document.getElementById('configDesc').value.trim();

            if (!key || !value) { alert('Key and Value are required'); return; }

            try {
                const res = await fetch(`${API}/configs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ config_key: key, config_value: value, config_type: type, description: desc })
                });
                const data = await res.json();
                if (data.success) {
                    closeModal();
                    showSystemConfigs();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function showEditConfigModal(configId) {
            const cfg = allConfigs.find(c => c.id === configId);
            if (!cfg) return;

            document.getElementById('modalTitle').textContent = 'Edit Configuration';
            document.getElementById('modalBody').innerHTML = `
                <div style="display:flex;flex-direction:column;gap:16px">
                    <div>
                        <label style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px">Config Key</label>
                        <input type="text" id="editConfigKey" value="${cfg.config_key}" disabled style="width:100%;padding:10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-muted)">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px">Config Value *</label>
                        <input type="text" id="editConfigValue" value="${cfg.config_value}" style="width:100%;padding:10px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary)">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px">Type</label>
                        <select id="editConfigType" style="width:100%;padding:10px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary)">
                            <option value="STRING" ${cfg.config_type === 'STRING' ? 'selected' : ''}>STRING</option>
                            <option value="NUMBER" ${cfg.config_type === 'NUMBER' ? 'selected' : ''}>NUMBER</option>
                            <option value="BOOLEAN" ${cfg.config_type === 'BOOLEAN' ? 'selected' : ''}>BOOLEAN</option>
                            <option value="JSON" ${cfg.config_type === 'JSON' ? 'selected' : ''}>JSON</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px">Description</label>
                        <input type="text" id="editConfigDesc" value="${cfg.description || ''}" style="width:100%;padding:10px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary)">
                    </div>
                    <button class="btn btn-primary" onclick="updateConfig('${configId}')">Update Configuration</button>
                </div>
            `;
            document.getElementById('stepModal').style.display = 'flex';
        }

        async function updateConfig(configId) {
            const value = document.getElementById('editConfigValue').value.trim();
            const type = document.getElementById('editConfigType').value;
            const desc = document.getElementById('editConfigDesc').value.trim();

            if (!value) { alert('Value is required'); return; }

            try {
                const res = await fetch(`${API}/configs/${configId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ config_value: value, config_type: type, description: desc })
                });
                const data = await res.json();
                if (data.success) {
                    closeModal();
                    showSystemConfigs();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteConfig(configId) {
            if (!confirm('Delete this configuration?')) return;

            try {
                const res = await fetch(`${API}/configs/${configId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showSystemConfigs();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // ============================================
        // PROCESS LOGS
        // ============================================
        async function showProcessLogs() {
            setTitle('Process Logs');
            setActions(`
                <select id="logTypeFilter" onchange="filterLogs()" style="padding:8px 12px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary)">
                    <option value="">All Types</option>
                    <option value="INSTANCE_CREATED">Instance Created</option>
                    <option value="INSTANCE_COMPLETED">Instance Completed</option>
                    <option value="INSTANCE_FAILED">Instance Failed</option>
                    <option value="WAITING_CALLBACK">Waiting Callback</option>
                    <option value="CALLBACK_RECEIVED">Callback Received</option>
                    <option value="CALLBACK_TIMEOUT">Callback Timeout</option>
                    <option value="BFS_CALLBACK_SENT">BFS Callback Sent</option>
                    <option value="BFS_CALLBACK_FAILED">BFS Callback Failed</option>
                </select>
                <button class="btn" onclick="showProcessLogs()">Refresh</button>
            `);
            setLoading();

            try {
                const res = await fetch(`${API}/logs?limit=200`);
                const data = await res.json();
                const logs = data.success ? (data.data || []) : [];

                if (logs.length === 0) {
                    setContent(`
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ“œ</div>
                            <h3>No Logs Found</h3>
                            <p>Process logs will appear here as flows execute.</p>
                        </div>
                    `);
                    return;
                }

                window.allLogs = logs;
                renderLogs(logs);
            } catch (err) {
                setContent(`<div class="empty-state"><div class="empty-icon">âŒ</div><h3>Error</h3><p>${err.message}</p></div>`);
            }
        }

        function filterLogs() {
            const filter = document.getElementById('logTypeFilter').value;
            const filtered = filter ? window.allLogs.filter(l => l.log_type === filter) : window.allLogs;
            renderLogs(filtered);
        }

        function renderLogs(logs) {
            const getLogTypeColor = (type) => {
                const colors = {
                    'INSTANCE_CREATED': 'var(--accent-blue)',
                    'INSTANCE_COMPLETED': 'var(--accent-green)',
                    'INSTANCE_FAILED': 'var(--accent-red)',
                    'WAITING_CALLBACK': 'var(--accent-yellow)',
                    'CALLBACK_RECEIVED': 'var(--accent-cyan)',
                    'CALLBACK_TIMEOUT': 'var(--accent-orange)',
                    'BFS_CALLBACK_SENT': 'var(--accent-purple)',
                    'BFS_CALLBACK_FAILED': 'var(--accent-red)'
                };
                return colors[type] || 'var(--text-muted)';
            };

            let html = `
                <div style="margin-bottom:16px;color:var(--text-secondary);font-size:13px">
                    Showing ${logs.length} log entries
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width:160px">Timestamp</th>
                            <th style="width:140px">Log Type</th>
                            <th style="width:280px">Flow Instance</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const log of logs) {
                const details = safeJSON(log.details);
                const detailStr = Object.keys(details).length > 0
                    ? `<code style="font-size:11px;background:var(--bg-primary);padding:2px 6px;border-radius:4px;word-break:break-all">${JSON.stringify(details).substring(0, 150)}${JSON.stringify(details).length > 150 ? '...' : ''}</code>`
                    : '<span style="color:var(--text-muted)">-</span>';

                html += `
                    <tr>
                        <td style="font-size:12px;color:var(--text-secondary)">${new Date(log.created_at).toLocaleString()}</td>
                        <td><span class="status-badge" style="background:${getLogTypeColor(log.log_type)}">${log.log_type}</span></td>
                        <td>
                            ${log.flow_instance_id
                                ? `<span class="clickable" onclick="analyzeFlowById('${log.flow_instance_id}')" style="font-size:11px">${log.flow_instance_id.substring(0, 8)}...</span>`
                                : '<span style="color:var(--text-muted)">-</span>'
                            }
                        </td>
                        <td>${detailStr}</td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            setContent(html);
        }

        async function analyzeFlowById(flowId) {
            try {
                const res = await fetch(`${API}/flow/${flowId}`);
                const data = await res.json();
                if (data.success) {
                    currentFlow = data.data;
                    await loadFlowAnalysis(data.data);
                } else {
                    alert('Flow not found');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Actions
        function analyzeFlow(sessionId) { document.getElementById('searchInput').value = sessionId; searchFlow(); }
        async function refreshFlow(id) { const res = await fetch(`${API}/flow/${id}`); const data = await res.json(); if (data.success) { currentFlow = data.data; await loadFlowAnalysis(data.data); } }
        async function resumeFlow(id) { if (!confirm('Resume flow?')) return; const res = await fetch(`${API}/fix/resume-flow/${id}`, { method: 'POST' }); const data = await res.json(); alert(data.success ? `Resumed! Job: ${data.jobId}` : `Error: ${data.error}`); if (currentFlow) refreshFlow(id); }
        async function resetCallback(id) { if (!confirm('Reset callback?')) return; const res = await fetch(`${API}/fix/reset-callback/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ minutes: 5 }) }); const data = await res.json(); alert(data.success ? 'Reset!' : `Error: ${data.error}`); loadTimedOutCallbacks(); }
        async function stopSpam() { if (!confirm('Stop all spam?')) return; const res = await fetch(`${API}/fix/stop-spam`, { method: 'POST' }); const data = await res.json(); alert(data.success ? data.message : `Error: ${data.error}`); loadCallbackSpam(); }
        async function retryJob(id) { const res = await fetch(`${API}/fix/retry-job/${id}`, { method: 'POST' }); const data = await res.json(); alert(data.success ? 'Retrying!' : `Error: ${data.error}`); loadJobQueue(); }

        // Helpers
        function setTitle(t) { document.getElementById('viewTitle').textContent = t; }
        function setActions(h) { document.getElementById('viewActions').innerHTML = h; }
        function setContent(h) { document.getElementById('contentBody').innerHTML = h; }
        function setLoading() { setContent('<div class="loading"><div class="spinner"></div>Loading...</div>'); }
        function safeJSON(s) { try { return typeof s === 'string' ? JSON.parse(s) : s; } catch { return {}; } }

        function updateSpeed(val) {
            // Invert: low slider value = slow (high ms), high slider value = fast (low ms)
            animationSpeed = 1800 - parseInt(val);
            const speedMultiplier = (800 / animationSpeed).toFixed(1);
            document.getElementById('speedLabel').textContent = speedMultiplier + 'x';
            document.documentElement.style.setProperty('--pulse-speed', (animationSpeed * 0.7) + 'ms');
        }

        // Zoom functionality
        let currentZoom = 1;
        const minZoom = 0.5;
        const maxZoom = 2;
        const zoomStep = 0.1;

        function zoomIn() {
            if (currentZoom < maxZoom) {
                currentZoom = Math.min(currentZoom + zoomStep, maxZoom);
                applyZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > minZoom) {
                currentZoom = Math.max(currentZoom - zoomStep, minZoom);
                applyZoom();
            }
        }

        function zoomReset() {
            currentZoom = 1;
            applyZoom();
        }

        function applyZoom() {
            const bpmnFlow = document.getElementById('bpmnFlow');
            if (bpmnFlow) {
                bpmnFlow.style.transform = `scale(${currentZoom})`;
                bpmnFlow.style.transformOrigin = 'left center';
            }
            const zoomLabel = document.getElementById('zoomLevel');
            if (zoomLabel) {
                zoomLabel.textContent = Math.round(currentZoom * 100) + '%';
            }
        }

        // Mouse wheel zoom
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.querySelector('.bpmn-canvas');
            if (canvas) {
                canvas.addEventListener('wheel', (e) => {
                    if (e.ctrlKey) {
                        e.preventDefault();
                        if (e.deltaY < 0) zoomIn();
                        else zoomOut();
                    }
                }, { passive: false });
            }
        });

        setInterval(checkHealth, 30000);

        // ============================================
        // VISUAL FLOW BUILDER
        // ============================================

        let builderState = {
            flowId: null,
            flowCode: '',
            nodes: [],
            connections: [],
            selectedNode: null,
            isDragging: false,
            isConnecting: false,
            connectingFrom: null,
            dragOffset: { x: 0, y: 0 },
            nextNodeId: 1
        };

        async function showVisualBuilder() {
            setTitle('Visual Flow Builder');
            setActions('');

            // Load available flows
            let flows = [];
            try {
                const res = await fetch(`${API}/flows/definitions`);
                const data = await res.json();
                flows = data.success ? data.data : [];
            } catch (err) {
                console.error('Failed to load flows:', err);
            }

            setContent(`
                <div class="builder-container">
                    <!-- Step Palette -->
                    <div class="builder-palette">
                        <div class="palette-title">Step Palette</div>

                        <div class="palette-section">
                            <div class="palette-section-title">Events</div>
                            <div class="palette-item" draggable="true" data-type="START">
                                <div class="palette-item-icon start">â–¶</div>
                                <div class="palette-item-info">
                                    <div class="palette-item-name">Start</div>
                                    <div class="palette-item-desc">Flow entry point</div>
                                </div>
                            </div>
                            <div class="palette-item" draggable="true" data-type="END">
                                <div class="palette-item-icon end">â—‰</div>
                                <div class="palette-item-info">
                                    <div class="palette-item-name">End</div>
                                    <div class="palette-item-desc">Flow exit point</div>
                                </div>
                            </div>
                        </div>

                        <div class="palette-section">
                            <div class="palette-section-title">Tasks</div>
                            <div class="palette-item" draggable="true" data-type="TRANSFORM">
                                <div class="palette-item-icon transform">âš™</div>
                                <div class="palette-item-info">
                                    <div class="palette-item-name">Transform</div>
                                    <div class="palette-item-desc">Data transformation</div>
                                </div>
                            </div>
                            <div class="palette-item" draggable="true" data-type="API_CALL">
                                <div class="palette-item-icon api-call">â†—</div>
                                <div class="palette-item-info">
                                    <div class="palette-item-name">API Call</div>
                                    <div class="palette-item-desc">External service call</div>
                                </div>
                            </div>
                        </div>

                        <div class="palette-section">
                            <div class="palette-section-title">Flow Control</div>
                            <div class="palette-item" draggable="true" data-type="CONDITION">
                                <div class="palette-item-icon condition"><span>âœ•</span></div>
                                <div class="palette-item-info">
                                    <div class="palette-item-name">Condition</div>
                                    <div class="palette-item-desc">Decision gateway</div>
                                </div>
                            </div>
                            <div class="palette-item" draggable="true" data-type="CALLBACK">
                                <div class="palette-item-icon callback">âœ‰</div>
                                <div class="palette-item-info">
                                    <div class="palette-item-name">Callback</div>
                                    <div class="palette-item-desc">Wait for callback</div>
                                </div>
                            </div>
                        </div>

                        <div class="palette-section" style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 16px;">
                            <div class="palette-section-title">Tips</div>
                            <div style="font-size: 11px; color: var(--text-muted); line-height: 1.5;">
                                <p style="margin-bottom: 8px;">â€¢ Drag steps to canvas</p>
                                <p style="margin-bottom: 8px;">â€¢ Click ports to connect</p>
                                <p style="margin-bottom: 8px;">â€¢ Click node to edit</p>
                                <p>â€¢ Use toolbar to save</p>
                            </div>
                        </div>
                    </div>

                    <!-- Canvas -->
                    <div class="builder-canvas">
                        <div class="canvas-toolbar">
                            <div class="canvas-toolbar-left">
                                <select class="canvas-flow-select" id="builderFlowSelect" onchange="loadFlowToBuilder(this.value)">
                                    <option value="">-- New Flow --</option>
                                    ${flows.map(f => `<option value="${f.id}">${f.flow_code} - ${f.flow_name || 'Unnamed'}</option>`).join('')}
                                </select>
                                <button class="canvas-btn" onclick="createNewFlow()">+ New</button>
                            </div>
                            <div class="canvas-toolbar-right">
                                <button class="canvas-btn" onclick="autoLayoutNodes()">âš¡ Auto Layout</button>
                                <button class="canvas-btn" onclick="clearCanvas()">ðŸ—‘ Clear</button>
                                <button class="canvas-btn success" onclick="saveFlowFromBuilder()">ðŸ’¾ Save Flow</button>
                            </div>
                        </div>
                        <div class="canvas-area" id="builderCanvasArea">
                            <svg class="connections-layer" id="connectionsLayer"></svg>
                            <div class="canvas-inner" id="builderCanvasInner">
                                <div class="canvas-empty" id="canvasEmptyState">
                                    <div class="canvas-empty-icon">ðŸŽ¨</div>
                                    <div class="canvas-empty-title">Start Building</div>
                                    <div class="canvas-empty-text">
                                        Drag steps from the palette on the left to start building your flow.
                                        Or select an existing flow from the dropdown above.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Properties Panel -->
                    <div class="builder-properties">
                        <div class="properties-title">
                            <span>Properties</span>
                            <span id="propNodeType" style="font-size:10px;background:var(--bg-tertiary);padding:3px 8px;border-radius:4px;"></span>
                        </div>
                        <div id="propertiesContent">
                            <div class="properties-empty">
                                <div class="properties-empty-icon">ðŸ“‹</div>
                                <div class="properties-empty-text">Select a node on the canvas to view and edit its properties</div>
                            </div>
                        </div>
                    </div>
                </div>
            `);

            initBuilderEvents();
            resetBuilderState();
        }

        function resetBuilderState() {
            builderState = {
                flowId: null,
                flowCode: '',
                nodes: [],
                connections: [],
                selectedNode: null,
                isDragging: false,
                isConnecting: false,
                connectingFrom: null,
                dragOffset: { x: 0, y: 0 },
                nextNodeId: 1
            };
            updateCanvasEmptyState();
        }

        function initBuilderEvents() {
            const canvas = document.getElementById('builderCanvasArea');
            const inner = document.getElementById('builderCanvasInner');
            if (!canvas || !inner) return;

            // Palette drag events
            document.querySelectorAll('.palette-item[draggable]').forEach(item => {
                item.addEventListener('dragstart', handlePaletteDragStart);
                item.addEventListener('dragend', handlePaletteDragEnd);
            });

            // Canvas drop events
            canvas.addEventListener('dragover', handleCanvasDragOver);
            canvas.addEventListener('drop', handleCanvasDrop);
            canvas.addEventListener('dragleave', handleCanvasDragLeave);

            // Canvas click (deselect and cancel connecting)
            inner.addEventListener('click', (e) => {
                if (e.target === inner || e.target.classList.contains('canvas-empty')) {
                    selectNode(null);
                    // Cancel any active connection attempt
                    if (builderState.isConnecting) {
                        cancelConnecting();
                    }
                }
            });

            // ESC key to cancel connecting
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && builderState.isConnecting) {
                    cancelConnecting();
                }
            });
        }

        function handlePaletteDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.closest('.palette-item').dataset.type);
            e.target.closest('.palette-item').classList.add('dragging');
        }

        function handlePaletteDragEnd(e) {
            e.target.closest('.palette-item').classList.remove('dragging');
        }

        function handleCanvasDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleCanvasDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleCanvasDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            const type = e.dataTransfer.getData('text/plain');
            if (!type) return;

            const canvas = document.getElementById('builderCanvasInner');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left - 60;
            const y = e.clientY - rect.top - 35;

            addNodeToCanvas(type, x, y);
        }

        function addNodeToCanvas(type, x, y, existingData = null) {
            const nodeId = existingData?.id || `node_${builderState.nextNodeId++}`;
            const stepCode = existingData?.step_code || generateStepCode(type);

            // Parse config and input_mapping if they're JSON strings
            let config = existingData?.config || getDefaultConfig(type);
            let inputMapping = existingData?.input_mapping || [];

            if (typeof config === 'string') {
                try { config = JSON.parse(config); } catch (e) { config = {}; }
            }
            if (typeof inputMapping === 'string') {
                try { inputMapping = JSON.parse(inputMapping); } catch (e) { inputMapping = []; }
            }

            const node = {
                id: nodeId,
                type: type,
                stepCode: stepCode,
                x: x,
                y: y,
                config: config || {},
                inputMapping: inputMapping || [],
                stepOrder: existingData?.step_order || builderState.nodes.length
            };

            builderState.nodes.push(node);
            renderNode(node);
            updateCanvasEmptyState();
            selectNode(nodeId);

            return node;
        }

        function generateStepCode(type) {
            const prefix = builderState.flowCode || 'FLOW';
            const count = builderState.nodes.filter(n => n.type === type).length + 1;
            return `${prefix}_${type}_${count}`;
        }

        function getDefaultConfig(type) {
            switch (type) {
                case 'API_CALL':
                    return { apiId: '', pathTemplate: '', method: 'POST', expectCallback: false };
                case 'TRANSFORM':
                    return { mappingCode: '' };
                case 'CONDITION':
                    return { condition_field: 'actionCode', success_values: ['000'], failure_values: [] };
                case 'CALLBACK':
                    return { callbackTimeout: 300000 };
                default:
                    return {};
            }
        }

        function renderNode(node) {
            const inner = document.getElementById('builderCanvasInner');
            if (!inner) return;

            const typeClass = node.type.toLowerCase().replace('_', '-');
            const icon = getBuilderStepIcon(node.type);

            const nodeEl = document.createElement('div');
            nodeEl.className = `canvas-node ${node.type.toLowerCase()}`;
            nodeEl.id = `canvas-node-${node.id}`;
            nodeEl.style.left = `${node.x}px`;
            nodeEl.style.top = `${node.y}px`;
            nodeEl.dataset.nodeId = node.id;

            const showLabel = !['START', 'END'].includes(node.type);
            const isCondition = node.type === 'CONDITION';

            nodeEl.innerHTML = `
                <div class="node-body ${typeClass}">
                    <div class="node-content">
                        <span class="node-icon">${icon}</span>
                        ${showLabel && !isCondition ? `<span class="node-label">${node.stepCode}</span>` : ''}
                    </div>
                    ${node.type !== 'START' ? `<div class="node-port input" data-port="input"></div>` : ''}
                    ${node.type !== 'END' ? (isCondition ? `
                        <div class="node-port output-yes" data-port="output-yes" title="Yes/Success"></div>
                        <div class="node-port output-no" data-port="output-no" title="No/Failure"></div>
                    ` : `<div class="node-port output" data-port="output"></div>`) : ''}
                </div>
                <div class="node-label-external">${node.stepCode}</div>
                <div class="node-delete" onclick="deleteNode('${node.id}')">&times;</div>
            `;

            // Node events
            nodeEl.addEventListener('mousedown', handleNodeMouseDown);
            nodeEl.addEventListener('click', (e) => {
                if (!e.target.classList.contains('node-port') && !e.target.classList.contains('node-delete')) {
                    selectNode(node.id);
                }
            });

            // Port events - drag-based connections
            nodeEl.querySelectorAll('.node-port').forEach(port => {
                port.addEventListener('mousedown', handlePortMouseDown);
            });

            inner.appendChild(nodeEl);
        }

        function getBuilderStepIcon(type) {
            const icons = {
                'START': 'â–¶',
                'END': 'â—‰',
                'TRANSFORM': 'âš™',
                'API_CALL': 'â†—',
                'CONDITION': 'âœ•',
                'CALLBACK': 'âœ‰'
            };
            return icons[type] || 'â–¢';
        }

        function handleNodeMouseDown(e) {
            if (e.target.classList.contains('node-port') || e.target.classList.contains('node-delete')) return;

            const nodeEl = e.target.closest('.canvas-node');
            if (!nodeEl) return;

            const nodeId = nodeEl.dataset.nodeId;
            const node = builderState.nodes.find(n => n.id === nodeId);
            if (!node) return;

            builderState.isDragging = true;
            nodeEl.classList.add('dragging');

            const rect = nodeEl.getBoundingClientRect();
            builderState.dragOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };

            const handleMouseMove = (e) => {
                if (!builderState.isDragging) return;

                const canvas = document.getElementById('builderCanvasInner');
                const canvasRect = canvas.getBoundingClientRect();

                node.x = e.clientX - canvasRect.left - builderState.dragOffset.x;
                node.y = e.clientY - canvasRect.top - builderState.dragOffset.y;

                // Snap to grid
                node.x = Math.round(node.x / 15) * 15;
                node.y = Math.round(node.y / 15) * 15;

                nodeEl.style.left = `${node.x}px`;
                nodeEl.style.top = `${node.y}px`;

                renderConnections();
            };

            const handleMouseUp = () => {
                builderState.isDragging = false;
                nodeEl.classList.remove('dragging');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function handlePortMouseDown(e) {
            e.stopPropagation();
            e.preventDefault();

            const port = e.target;
            const nodeEl = port.closest('.canvas-node');
            const nodeId = nodeEl.dataset.nodeId;
            const portType = port.dataset.port;

            // Only start drag from output ports
            if (!portType.startsWith('output')) return;

            builderState.isConnecting = true;
            builderState.connectingFrom = { nodeId, portType, port };
            port.classList.add('connecting');

            // Get start position
            const svg = document.getElementById('connectionsLayer');
            const svgRect = svg.getBoundingClientRect();
            const portRect = port.getBoundingClientRect();
            const startX = portRect.left + portRect.width / 2 - svgRect.left;
            const startY = portRect.top + portRect.height / 2 - svgRect.top;

            // Create preview line
            let previewLine = document.getElementById('connectionPreview');
            if (!previewLine) {
                previewLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                previewLine.id = 'connectionPreview';
                previewLine.setAttribute('class', 'connection-preview');
                svg.appendChild(previewLine);
            }
            previewLine.style.display = 'block';

            // Highlight valid targets (input ports on other nodes)
            document.querySelectorAll('.node-port.input').forEach(p => {
                if (p.closest('.canvas-node').dataset.nodeId !== nodeId) {
                    p.classList.add('valid-target');
                }
            });

            showConnectionHelper('Drag to an input port (left side) to connect, release to cancel');

            const handleMouseMove = (e) => {
                const mouseX = e.clientX - svgRect.left;
                const mouseY = e.clientY - svgRect.top;

                // Draw curved preview line
                const midX = (startX + mouseX) / 2;
                const pathD = `M${startX},${startY} C${midX},${startY} ${midX},${mouseY} ${mouseX},${mouseY}`;
                previewLine.setAttribute('d', pathD);

                // Check if hovering over a valid target
                const elemUnderMouse = document.elementFromPoint(e.clientX, e.clientY);
                document.querySelectorAll('.node-port.valid-target').forEach(p => p.classList.remove('hover-target'));
                if (elemUnderMouse && elemUnderMouse.classList.contains('node-port') && elemUnderMouse.classList.contains('valid-target')) {
                    elemUnderMouse.classList.add('hover-target');
                }
            };

            const handleMouseUp = (e) => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);

                // Hide preview line
                if (previewLine) previewLine.style.display = 'none';

                // Check if released on a valid input port
                const elemUnderMouse = document.elementFromPoint(e.clientX, e.clientY);
                if (elemUnderMouse && elemUnderMouse.classList.contains('node-port') &&
                    elemUnderMouse.dataset.port === 'input') {
                    const targetNodeEl = elemUnderMouse.closest('.canvas-node');
                    const targetNodeId = targetNodeEl.dataset.nodeId;

                    if (targetNodeId !== nodeId) {
                        const conn = {
                            from: nodeId,
                            to: targetNodeId,
                            type: portType === 'output-yes' ? 'yes' :
                                  portType === 'output-no' ? 'no' : 'default'
                        };

                        // Check if connection already exists
                        const exists = builderState.connections.find(c =>
                            c.from === conn.from && c.to === conn.to && c.type === conn.type
                        );

                        if (!exists) {
                            builderState.connections.push(conn);
                            renderConnections();
                        }
                    }
                }

                cancelConnecting();
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function cancelConnecting() {
            builderState.isConnecting = false;
            builderState.connectingFrom = null;
            document.querySelectorAll('.node-port.connecting').forEach(p => p.classList.remove('connecting'));
            document.querySelectorAll('.node-port.valid-target').forEach(p => p.classList.remove('valid-target'));
            document.querySelectorAll('.node-port.hover-target').forEach(p => p.classList.remove('hover-target'));
            const preview = document.getElementById('connectionPreview');
            if (preview) preview.style.display = 'none';
            hideConnectionHelper();
        }

        function showConnectionHelper(msg) {
            let helper = document.getElementById('connectionHelper');
            if (!helper) {
                helper = document.createElement('div');
                helper.id = 'connectionHelper';
                helper.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--accent-blue);color:white;padding:10px 20px;border-radius:8px;font-size:12px;z-index:1000;box-shadow:0 4px 15px rgba(0,0,0,0.3);';
                document.body.appendChild(helper);
            }
            helper.textContent = msg;
            helper.style.display = 'block';
        }

        function hideConnectionHelper() {
            const helper = document.getElementById('connectionHelper');
            if (helper) helper.style.display = 'none';
        }

        function renderConnections() {
            const svg = document.getElementById('connectionsLayer');
            if (!svg) return;

            svg.innerHTML = '';

            builderState.connections.forEach(conn => {
                const fromNode = document.getElementById(`canvas-node-${conn.from}`);
                const toNode = document.getElementById(`canvas-node-${conn.to}`);
                if (!fromNode || !toNode) return;

                const fromPort = conn.type === 'yes' ? fromNode.querySelector('.node-port.output-yes') :
                                 conn.type === 'no' ? fromNode.querySelector('.node-port.output-no') :
                                 fromNode.querySelector('.node-port.output');
                const toPort = toNode.querySelector('.node-port.input');
                if (!fromPort || !toPort) return;

                const fromRect = fromPort.getBoundingClientRect();
                const toRect = toPort.getBoundingClientRect();
                const svgRect = svg.getBoundingClientRect();

                const x1 = fromRect.left + fromRect.width / 2 - svgRect.left;
                const y1 = fromRect.top + fromRect.height / 2 - svgRect.top;
                const x2 = toRect.left + toRect.width / 2 - svgRect.left;
                const y2 = toRect.top + toRect.height / 2 - svgRect.top;

                // Create a group for this connection
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('class', 'connection-group');

                // Create curved path
                const midX = (x1 + x2) / 2;
                const pathD = `M${x1},${y1} C${midX},${y1} ${midX},${y2} ${x2},${y2}`;

                // Create invisible hit area (thicker for easier clicking)
                const hitArea = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                hitArea.setAttribute('d', pathD);
                hitArea.setAttribute('class', 'connection-line-hitarea');
                hitArea.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Delete this connection?')) {
                        deleteConnection(conn.from, conn.to, conn.type);
                    }
                });

                // Create visible path
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathD);
                path.setAttribute('class', 'connection-line' + (conn.type !== 'default' ? ` ${conn.type}` : ''));
                path.dataset.from = conn.from;
                path.dataset.to = conn.to;

                // Arrow head
                const arrowSize = 8;
                const arrowX = x2 - 5;
                const arrowY = y2;

                const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                const points = [
                    [arrowX, arrowY],
                    [arrowX - arrowSize, arrowY - arrowSize / 2],
                    [arrowX - arrowSize, arrowY + arrowSize / 2]
                ].map(p => p.join(',')).join(' ');
                arrow.setAttribute('points', points);
                arrow.setAttribute('class', 'connection-arrow');

                // Add delete button at midpoint
                const midY = (y1 + y2) / 2;
                const deleteBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                deleteBtn.setAttribute('class', 'connection-delete-btn');
                deleteBtn.setAttribute('transform', `translate(${midX}, ${midY})`);
                deleteBtn.innerHTML = `
                    <circle r="10" fill="var(--accent-red)" />
                    <text x="0" y="4" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Ã—</text>
                `;
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteConnection(conn.from, conn.to, conn.type);
                });

                group.appendChild(hitArea);
                group.appendChild(path);
                group.appendChild(arrow);
                group.appendChild(deleteBtn);
                svg.appendChild(group);

                // Add type label for conditional connections
                if (conn.type === 'yes' || conn.type === 'no') {
                    const labelX = x1 + 30;
                    const labelY = y1 + (conn.type === 'yes' ? -10 : 10);

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', labelX);
                    text.setAttribute('y', labelY);
                    text.setAttribute('fill', conn.type === 'yes' ? 'var(--accent-green)' : 'var(--accent-red)');
                    text.setAttribute('font-size', '10');
                    text.setAttribute('font-weight', 'bold');
                    text.setAttribute('pointer-events', 'none');
                    text.textContent = conn.type.toUpperCase();
                    svg.appendChild(text);
                }
            });
        }

        function deleteConnection(from, to, type) {
            builderState.connections = builderState.connections.filter(c =>
                !(c.from === from && c.to === to && c.type === type)
            );
            renderConnections();
        }

        function deleteNode(nodeId) {
            if (!confirm('Delete this step?')) return;

            // Remove node
            builderState.nodes = builderState.nodes.filter(n => n.id !== nodeId);

            // Remove connections
            builderState.connections = builderState.connections.filter(c =>
                c.from !== nodeId && c.to !== nodeId
            );

            // Remove from DOM
            const el = document.getElementById(`canvas-node-${nodeId}`);
            if (el) el.remove();

            // Deselect if selected
            if (builderState.selectedNode === nodeId) {
                selectNode(null);
            }

            renderConnections();
            updateCanvasEmptyState();
        }

        function selectNode(nodeId) {
            // Deselect previous
            document.querySelectorAll('.canvas-node.selected').forEach(n => n.classList.remove('selected'));

            builderState.selectedNode = nodeId;

            if (nodeId) {
                const el = document.getElementById(`canvas-node-${nodeId}`);
                if (el) el.classList.add('selected');
                showNodeProperties(nodeId);
            } else {
                showEmptyProperties();
            }
        }

        function showEmptyProperties() {
            const container = document.getElementById('propertiesContent');
            document.getElementById('propNodeType').textContent = '';
            container.innerHTML = `
                <div class="properties-empty">
                    <div class="properties-empty-icon">ðŸ“‹</div>
                    <div class="properties-empty-text">Select a node on the canvas to view and edit its properties</div>
                </div>
            `;
        }

        function showNodeProperties(nodeId) {
            const node = builderState.nodes.find(n => n.id === nodeId);
            if (!node) return;

            const container = document.getElementById('propertiesContent');
            const typeLabel = document.getElementById('propNodeType');
            typeLabel.textContent = node.type;

            let html = `
                <div class="properties-form">
                    <div class="prop-group">
                        <label class="prop-label">Step Code</label>
                        <input type="text" class="prop-input" value="${node.stepCode}" onchange="updateNodeProperty('${nodeId}', 'stepCode', this.value)">
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">Step Order</label>
                        <input type="number" class="prop-input" value="${node.stepOrder}" onchange="updateNodeProperty('${nodeId}', 'stepOrder', parseInt(this.value))">
                    </div>
            `;

            // Type-specific properties
            switch (node.type) {
                case 'API_CALL':
                    html += `
                        <div class="prop-section">
                            <div class="prop-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                                API Configuration <span>â–¼</span>
                            </div>
                            <div class="prop-section-body">
                                <div class="prop-group">
                                    <label class="prop-label">API ID</label>
                                    <input type="text" class="prop-input" value="${node.config.apiId || ''}"
                                           onchange="updateNodeConfig('${nodeId}', 'apiId', this.value)"
                                           placeholder="External API UUID">
                                </div>
                                <div class="prop-group">
                                    <label class="prop-label">Path Template</label>
                                    <input type="text" class="prop-input" value="${node.config.pathTemplate || ''}"
                                           onchange="updateNodeConfig('${nodeId}', 'pathTemplate', this.value)"
                                           placeholder="/api/endpoint">
                                </div>
                                <div class="prop-group">
                                    <label class="prop-label">HTTP Method</label>
                                    <select class="prop-select" onchange="updateNodeConfig('${nodeId}', 'method', this.value)">
                                        <option value="GET" ${node.config.method === 'GET' ? 'selected' : ''}>GET</option>
                                        <option value="POST" ${node.config.method === 'POST' ? 'selected' : ''}>POST</option>
                                        <option value="PUT" ${node.config.method === 'PUT' ? 'selected' : ''}>PUT</option>
                                        <option value="DELETE" ${node.config.method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                                    </select>
                                </div>
                                <label class="prop-checkbox">
                                    <input type="checkbox" ${node.config.expectCallback ? 'checked' : ''}
                                           onchange="updateNodeConfig('${nodeId}', 'expectCallback', this.checked)">
                                    Expect Callback
                                </label>
                            </div>
                        </div>
                    `;
                    break;

                case 'TRANSFORM':
                    html += `
                        <div class="prop-section">
                            <div class="prop-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                                Transform Configuration <span>â–¼</span>
                            </div>
                            <div class="prop-section-body">
                                <div class="prop-group">
                                    <label class="prop-label">Mapping Code</label>
                                    <input type="text" class="prop-input" value="${node.config.mappingCode || ''}"
                                           onchange="updateNodeConfig('${nodeId}', 'mappingCode', this.value)"
                                           placeholder="MAPPING_CODE">
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'CONDITION':
                    html += `
                        <div class="prop-section">
                            <div class="prop-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                                Condition Configuration <span>â–¼</span>
                            </div>
                            <div class="prop-section-body">
                                <div class="prop-group">
                                    <label class="prop-label">Condition Field</label>
                                    <input type="text" class="prop-input" value="${node.config.condition_field || 'actionCode'}"
                                           onchange="updateNodeConfig('${nodeId}', 'condition_field', this.value)">
                                </div>
                                <div class="prop-group">
                                    <label class="prop-label">Success Values (comma-separated)</label>
                                    <input type="text" class="prop-input" value="${(node.config.success_values || []).join(', ')}"
                                           onchange="updateNodeConfig('${nodeId}', 'success_values', this.value.split(',').map(v => v.trim()).filter(v => v))">
                                </div>
                                <div class="prop-group">
                                    <label class="prop-label">Failure Values (comma-separated)</label>
                                    <input type="text" class="prop-input" value="${(node.config.failure_values || []).join(', ')}"
                                           onchange="updateNodeConfig('${nodeId}', 'failure_values', this.value.split(',').map(v => v.trim()).filter(v => v))">
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'CALLBACK':
                    html += `
                        <div class="prop-section">
                            <div class="prop-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                                Callback Configuration <span>â–¼</span>
                            </div>
                            <div class="prop-section-body">
                                <div class="prop-group">
                                    <label class="prop-label">Timeout (ms)</label>
                                    <input type="number" class="prop-input" value="${node.config.callbackTimeout || 300000}"
                                           onchange="updateNodeConfig('${nodeId}', 'callbackTimeout', parseInt(this.value))">
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }

            // Input Mapping section
            if (!['START', 'END'].includes(node.type)) {
                html += `
                    <div class="prop-section">
                        <div class="prop-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                            Input Mapping <span>â–¼</span>
                        </div>
                        <div class="prop-section-body">
                            <textarea class="prop-textarea" placeholder='[{"source": "field1", "target": "field2"}]'
                                onchange="updateNodeProperty('${nodeId}', 'inputMapping', JSON.parse(this.value || '[]'))">${JSON.stringify(node.inputMapping || [], null, 2)}</textarea>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function updateNodeProperty(nodeId, property, value) {
            const node = builderState.nodes.find(n => n.id === nodeId);
            if (node) {
                node[property] = value;
                // Update visual label if step code changed
                if (property === 'stepCode') {
                    const el = document.getElementById(`canvas-node-${nodeId}`);
                    if (el) {
                        const labelEl = el.querySelector('.node-label-external');
                        if (labelEl) labelEl.textContent = value;
                        const innerLabel = el.querySelector('.node-label');
                        if (innerLabel) innerLabel.textContent = value;
                    }
                }
            }
        }

        function updateNodeConfig(nodeId, property, value) {
            const node = builderState.nodes.find(n => n.id === nodeId);
            if (node) {
                if (!node.config) node.config = {};
                node.config[property] = value;
            }
        }

        function updateCanvasEmptyState() {
            const empty = document.getElementById('canvasEmptyState');
            if (empty) {
                empty.style.display = builderState.nodes.length > 0 ? 'none' : 'flex';
            }
        }

        function clearCanvas() {
            if (builderState.nodes.length === 0) return;
            if (!confirm('Clear all nodes from the canvas?')) return;

            builderState.nodes.forEach(node => {
                const el = document.getElementById(`canvas-node-${node.id}`);
                if (el) el.remove();
            });

            builderState.nodes = [];
            builderState.connections = [];
            builderState.selectedNode = null;

            renderConnections();
            updateCanvasEmptyState();
            showEmptyProperties();
        }

        function autoLayoutNodes() {
            if (builderState.nodes.length === 0) return;

            // Sort by step order
            const sorted = [...builderState.nodes].sort((a, b) => a.stepOrder - b.stepOrder);

            const startX = 50;
            const startY = 50;
            const xGap = 200;
            const yGap = 120;
            const nodesPerRow = 4;

            sorted.forEach((node, i) => {
                const row = Math.floor(i / nodesPerRow);
                const col = i % nodesPerRow;

                node.x = startX + col * xGap;
                node.y = startY + row * yGap;

                const el = document.getElementById(`canvas-node-${node.id}`);
                if (el) {
                    el.style.left = `${node.x}px`;
                    el.style.top = `${node.y}px`;
                }
            });

            renderConnections();
        }

        async function loadFlowToBuilder(flowId) {
            if (!flowId) {
                resetBuilderState();
                clearCanvasNodes();
                return;
            }

            try {
                // Load flow and steps
                const [flowRes, stepsRes] = await Promise.all([
                    fetch(`${API}/flows/definitions`),
                    fetch(`${API}/flows/${flowId}/steps`)
                ]);

                const flowsData = await flowRes.json();
                const stepsData = await stepsRes.json();

                const flow = (flowsData.data || []).find(f => f.id === flowId);
                if (!flow) {
                    alert('Flow not found');
                    return;
                }

                resetBuilderState();
                clearCanvasNodes();

                builderState.flowId = flowId;
                builderState.flowCode = flow.flow_code;

                // Add nodes from steps
                const steps = stepsData.success ? stepsData.data : [];
                if (steps.length === 0) {
                    // Add default START node for empty flow
                    addNodeToCanvas('START', 50, 150);
                    addNodeToCanvas('END', 600, 150);
                } else {
                    // Sort by step_order
                    const sortedSteps = [...steps].sort((a, b) => (a.step_order || 0) - (b.step_order || 0));

                    sortedSteps.forEach((step, i) => {
                        const x = 50 + (i % 5) * 180;
                        const y = 80 + Math.floor(i / 5) * 140;
                        addNodeToCanvas(step.step_type, x, y, step);
                    });

                    // Create connections based on step_order sequence
                    // Each step connects to the next one in order
                    for (let i = 0; i < sortedSteps.length - 1; i++) {
                        const currentStep = sortedSteps[i];
                        const nextStep = sortedSteps[i + 1];

                        // Skip connecting FROM END nodes
                        if (currentStep.step_type === 'END') continue;

                        // For CONDITION steps, create YES path to next step
                        if (currentStep.step_type === 'CONDITION') {
                            builderState.connections.push({
                                from: currentStep.id,
                                to: nextStep.id,
                                type: 'yes'
                            });
                        } else {
                            builderState.connections.push({
                                from: currentStep.id,
                                to: nextStep.id,
                                type: 'default'
                            });
                        }
                    }

                    renderConnections();
                }

                autoLayoutNodes();

            } catch (err) {
                console.error('Failed to load flow:', err);
                alert('Failed to load flow: ' + err.message);
            }
        }

        function clearCanvasNodes() {
            document.querySelectorAll('.canvas-node').forEach(el => el.remove());
            const svg = document.getElementById('connectionsLayer');
            if (svg) svg.innerHTML = '';
            updateCanvasEmptyState();
        }

        function createNewFlow() {
            const code = prompt('Enter Flow Code (e.g., FT, REV, REQ):');
            if (!code) return;

            const name = prompt('Enter Flow Name (optional):');

            resetBuilderState();
            clearCanvasNodes();

            builderState.flowCode = code.toUpperCase();

            // Add START and END nodes
            addNodeToCanvas('START', 50, 150);
            addNodeToCanvas('END', 600, 150);

            // Reset dropdown
            document.getElementById('builderFlowSelect').value = '';

            alert(`New flow "${code}" created. Add steps and save when ready.`);
        }

        async function saveFlowFromBuilder() {
            if (builderState.nodes.length === 0) {
                alert('Add some steps before saving');
                return;
            }

            const flowCode = builderState.flowCode || prompt('Enter Flow Code:');
            if (!flowCode) return;

            try {
                let flowId = builderState.flowId;

                // Create flow if new
                if (!flowId) {
                    const flowName = prompt('Enter Flow Name (optional):') || flowCode;
                    const res = await fetch(`${API}/flows`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            flow_code: flowCode,
                            flow_name: flowName,
                            is_active: true
                        })
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error);
                    flowId = data.data.id;
                    builderState.flowId = flowId;
                }

                // Build step data - save all nodes except START/END virtual nodes
                const nodeIdMap = {};
                const stepsToSave = builderState.nodes.filter(n => !['START', 'END'].includes(n.type));

                // Assign step_order based on visual position (left to right, top to bottom)
                stepsToSave.sort((a, b) => {
                    const rowA = Math.floor(a.y / 100);
                    const rowB = Math.floor(b.y / 100);
                    if (rowA !== rowB) return rowA - rowB;
                    return a.x - b.x;
                });

                for (let i = 0; i < stepsToSave.length; i++) {
                    const node = stepsToSave[i];
                    node.stepOrder = i + 1;

                    const stepData = {
                        flow_id: flowId,
                        step_code: node.stepCode,
                        step_name: node.stepName || node.stepCode.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
                        step_type: node.type,
                        step_order: node.stepOrder,
                        config: node.config,
                        input_mapping: node.inputMapping
                    };

                    // Check if step exists (has real UUID)
                    const isExisting = node.id && node.id.match(/^[0-9a-f]{8}-/);

                    if (isExisting) {
                        // Update existing
                        const res = await fetch(`${API}/steps/${node.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(stepData)
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error);
                        nodeIdMap[node.id] = data.data.id;
                    } else {
                        // Create new
                        const res = await fetch(`${API}/steps`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(stepData)
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error);
                        nodeIdMap[node.id] = data.data.id;
                    }
                }

                alert('Flow saved successfully!');

                // Reload to get proper IDs
                document.getElementById('builderFlowSelect').value = flowId;
                await loadFlowToBuilder(flowId);

            } catch (err) {
                console.error('Save failed:', err);
                alert('Failed to save: ' + err.message);
            }
        }
    </script>
</body>
</html>
